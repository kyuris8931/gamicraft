<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gambar Lokal dari Tasker ke Netlify PWA</title>

    <meta name="autotoolswebscreen"
          type="variablejs"
          id="dataGambarBase64"
          label="Data Gambar (Base64)"
          description="String Base64 dari gambar lokal."
          defaultValue="" />
    <meta name="autotoolswebscreen"
          type="variablejs"
          id="tipeMimeGambar"
          label="Tipe MIME Gambar"
          description="Contoh: image/jpeg, image/png."
          defaultValue="image/png" />
    <meta name="autotoolswebscreen"
          type="variablejs"
          id="infoStatusGambar"
          label="Info Status"
          description="Pesan status dari Tasker atau PWA."
          defaultValue="Menunggu instruksi dari Tasker..." />

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 90vh;
        }
        .container {
            background-color: #ffffff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 500px;
            text-align: center;
        }
        h1 {
            color: #1877f2; /* Biru Facebook */
            margin-bottom: 20px;
            font-size: 1.8em;
        }
        #placeholderGambar {
            width: 100%;
            max-width: 300px; /* Batasi lebar maksimum gambar */
            min-height: 150px;
            margin-top: 20px;
            margin-bottom: 20px;
            border: 3px dashed #ccd0d5; /* Abu-abu Facebook */
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #e9ebee; /* Latar abu-abu sangat muda */
            color: #606770; /* Teks abu-abu */
            font-style: italic;
            border-radius: 8px;
            object-fit: contain; /* Agar gambar tidak terdistorsi */
        }
        #statusPesan {
            margin-top: 15px;
            color: #606770;
            font-size: 0.95em;
            min-height: 20px;
        }
        .log-box {
            margin-top: 25px;
            padding: 10px;
            background-color: #f7f7f7;
            border: 1px solid #dddfe2;
            border-radius: 6px;
            text-align: left;
            font-size: 0.8em;
            max-height: 150px;
            overflow-y: auto;
            color: #333;
        }
        .log-box strong {
            color: #1877f2;
        }
        .log-box pre {
            margin: 0;
            white-space: pre-wrap;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Tampilan Gambar Lokal</h1>
        <img id="placeholderGambar" src="" alt="Area Gambar" />
        <p id="statusPesan">Menunggu instruksi dari Tasker...</p>

        <div class="log-box">
            <strong>Log PWA:</strong>
            <pre id="logOutputPWA"></pre>
        </div>
    </div>

    <script type="text/javascript">
        // Elemen global
        let elGambar, elStatus, elLog;

        function catatLog(pesan) {
            if (elLog) {
                const waktu = new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                elLog.textContent += `[${waktu}] ${pesan}\n`;
                elLog.scrollTop = elLog.scrollHeight; // Auto scroll ke bawah
            }
            console.log(`[PWA Gambar Lokal] ${pesan}`);
        }

        document.addEventListener('DOMContentLoaded', function() {
            elGambar = document.getElementById('placeholderGambar');
            elStatus = document.getElementById('statusPesan');
            elLog = document.getElementById('logOutputPWA');

            catatLog("Halaman PWA siap (DOMContentLoaded).");

            // Menampilkan status awal dari meta tag (jika ada)
            if (typeof window.infoStatusGambar !== 'undefined') {
                elStatus.textContent = window.infoStatusGambar;
                catatLog(`Status awal dari meta: "${window.infoStatusGambar}"`);
            }

            // Menampilkan gambar awal dari meta jika ada (biasanya tidak untuk base64 besar)
            if (window.dataGambarBase64 && window.dataGambarBase64.length > 10 && window.tipeMimeGambar) { // Cek panjang > 10 untuk validitas kasar
                catatLog(`Mencoba memuat gambar awal dari meta. Tipe: ${window.tipeMimeGambar}, Data (awal): ${window.dataGambarBase64.substring(0,30)}...`);
                elGambar.src = `data:${window.tipeMimeGambar};base64,${window.dataGambarBase64}`;
                elGambar.alt = "Gambar dimuat dari meta awal";
                elStatus.textContent = "Gambar awal dimuat dari meta.";
            } else {
                elGambar.alt = "Belum ada gambar"; // Teks jika src kosong
                catatLog("Tidak ada gambar awal dari meta atau data tidak valid.");
            }
        });

        // Fungsi ini akan dipanggil oleh AutoTools Web Screen untuk mengupdate nilai
        var autoToolsUpdateValues = function(values) {
            catatLog("autoToolsUpdateValues dipanggil oleh Tasker.");
            catatLog("Data diterima: " + JSON.stringify(values));

            let statusTelahDiupdate = false;

            // Update status pesan jika ada
            if (typeof values.infoStatusGambar !== 'undefined') {
                elStatus.textContent = values.infoStatusGambar;
                catatLog(`Info status diupdate menjadi: "${values.infoStatusGambar}"`);
                statusTelahDiupdate = true;
            }

            // Update gambar jika data Base64 dan tipe MIME ada
            if (typeof values.dataGambarBase64 !== 'undefined' && typeof values.tipeMimeGambar !== 'undefined') {
                const stringBase64 = values.dataGambarBase64;
                const mimeTipe = values.tipeMimeGambar;

                if (elGambar) {
                    if (stringBase64 && stringBase64.length > 10 && mimeTipe) { // Cek panjang > 10 untuk validitas kasar
                        catatLog(`Mengupdate gambar. Tipe: ${mimeTipe}, Data (awal): ${stringBase64.substring(0,30)}...`);
                        elGambar.src = `data:${mimeTipe};base64,${stringBase64}`;
                        elGambar.alt = "Gambar dari Tasker";
                        if (!statusTelahDiupdate) { // Hanya update status jika belum diupdate oleh infoStatusGambar
                            elStatus.textContent = "Gambar berhasil diperbarui!";
                        }
                    } else {
                        catatLog("Data Base64 atau tipe MIME tidak valid/kosong. Gambar tidak diubah atau dikosongkan.");
                        elGambar.src = ""; // Kosongkan jika data tidak valid
                        elGambar.alt = "Gagal memuat gambar dari Tasker";
                        if (!statusTelahDiupdate) {
                            elStatus.textContent = "Gagal memuat gambar: data tidak valid.";
                        }
                    }
                } else {
                    catatLog("Elemen <img> 'placeholderGambar' tidak ditemukan di DOM.");
                }
            } else {
                catatLog("Tidak ada 'dataGambarBase64' atau 'tipeMimeGambar' dalam data update.");
            }
        };

        catatLog("Skrip PWA selesai dimuat. Menunggu interaksi Tasker.");
    </script>
</body>
</html>
