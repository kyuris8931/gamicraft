<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Galeri Gambar Geser</title>

    <meta name="autotoolswebscreen" type="variablejs" id="jsonDataGambarSlider" label="Data JSON Gambar Slider" defaultValue="[]" />
    <meta name="autotoolswebscreen" type="variablejs" id="infoStatusSlider" label="Info Status Slider" defaultValue="Geser untuk melihat gambar." />

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0; /* Hapus padding agar slider bisa full width jika diinginkan */
            background-color: #f0f2f5;
            color: #1c1e21;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center; /* Pusatkan slider jika tidak full height */
            min-height: 100vh;
            overflow-x: hidden; /* Hindari scroll horizontal di body */
        }
        .slider-container {
            width: 90%; /* Lebar slider, bisa disesuaikan */
            max-width: 500px; /* Lebar maksimum slider */
            margin: 20px auto; /* Pusatkan slider */
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            overflow: hidden; /* Ini penting untuk menyembunyikan slide lain */
            position: relative; /* Untuk positioning tombol navigasi absolut */
        }
        .slider-wrapper {
            display: flex; /* Membuat slide berjajar horizontal */
            transition: transform 0.4s ease-in-out; /* Animasi geser */
        }
        .slide {
            min-width: 100%; /* Setiap slide mengambil lebar penuh kontainer */
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px; /* Padding di dalam slide */
            position: relative;
        }
        .slide img {
            max-width: 100%;
            max-height: 300px; /* Batas tinggi gambar */
            height: auto;
            border-radius: 8px;
            object-fit: contain;
            background-color: #e9ebee;
            margin-bottom: 10px;
        }
        .slide .caption {
            font-size: 0.9em;
            color: #606770;
            text-align: center;
            margin-top: 5px;
        }
        .nav-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.4);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            z-index: 10;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        .nav-button:hover {
            opacity: 1;
        }
        .nav-button.prev {
            left: 10px;
        }
        .nav-button.next {
            right: 10px;
        }
        .nav-button:disabled {
            opacity: 0.2;
            cursor: not-allowed;
        }
        .dots-container {
            text-align: center;
            padding: 10px 0;
        }
        .dot {
            height: 8px;
            width: 8px;
            margin: 0 4px;
            background-color: #bbb;
            border-radius: 50%;
            display: inline-block;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .dot.active {
            background-color: #007bff;
        }
        #statusSlider {
            margin-top:10px;
            text-align: center;
            font-size: 0.9em;
            color: #606770;
        }
        .log-area { margin-top: 15px; padding: 10px; background-color: #222; color: #0f0; border-radius: 5px; text-align: left; font-size: 0.7em; max-height: 120px; overflow-y: auto; font-family: 'Consolas', 'Courier New', monospace; }
        .log-area pre { margin: 0; white-space: pre-wrap; word-break: break-all; }
    </style>
</head>
<body>
    <div class="slider-container" id="imageSlider">
        <div class="slider-wrapper" id="sliderWrapper">
            </div>
        <button class="nav-button prev" id="prevBtn" aria-label="Gambar Sebelumnya">&lt;</button>
        <button class="nav-button next" id="nextBtn" aria-label="Gambar Berikutnya">&gt;</button>
        <div class="dots-container" id="dotsContainer">
            </div>
    </div>
    <p id="statusSlider">Geser untuk melihat gambar.</p>
    <div class="log-area" style="max-width: 500px; width: 90%;">
        <strong>Log PWA:</strong>
        <pre id="logOutputPWA"></pre>
    </div>

    <script type="text/javascript">
        let sliderWrapper, prevBtn, nextBtn, dotsContainer, elStatusSlider, elLogPWA;
        let currentIndex = 0;
        let slidesData = []; // Akan berisi {base64, mime, caption}
        let touchStartX = 0;
        let touchEndX = 0;
        const swipeThreshold = 50; // Minimal geseran (px) untuk dianggap swipe

        function catatLogPWA(pesan) {
            if (elLogPWA) {
                const waktu = new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                elLogPWA.textContent += `[${waktu}] ${pesan}\n`;
                elLogPWA.scrollTop = elLogPWA.scrollHeight;
            }
            console.log(`[PWA SwipeGallery] ${pesan}`);
        }

        function createSlides() {
            sliderWrapper.innerHTML = ''; // Kosongkan slide sebelumnya
            dotsContainer.innerHTML = ''; // Kosongkan dots sebelumnya

            if (!slidesData || slidesData.length === 0) {
                sliderWrapper.innerHTML = '<div class="slide"><p>Tidak ada gambar untuk ditampilkan.</p></div>';
                prevBtn.style.display = 'none';
                nextBtn.style.display = 'none';
                catatLogPWA("Tidak ada data gambar, slider kosong.");
                return;
            }

            slidesData.forEach((data, index) => {
                const slide = document.createElement('div');
                slide.classList.add('slide');

                const img = document.createElement('img');
                if (data.base64 && data.mime) {
                    img.src = `data:${data.mime};base64,${data.base64}`;
                } else {
                    img.src = ""; // Atau placeholder default
                }
                img.alt = data.caption || `Gambar ${index + 1}`;
                slide.appendChild(img);

                if (data.caption) {
                    const caption = document.createElement('p');
                    caption.classList.add('caption');
                    caption.textContent = data.caption;
                    slide.appendChild(caption);
                }
                sliderWrapper.appendChild(slide);

                // Buat dot indicator
                const dot = document.createElement('span');
                dot.classList.add('dot');
                dot.addEventListener('click', () => goToSlide(index));
                dotsContainer.appendChild(dot);
            });
            updateSlider();
            catatLogPWA(`Slider dibuat dengan ${slidesData.length} gambar.`);
        }

        function updateSlider() {
            if (!slidesData || slidesData.length === 0) return;
            sliderWrapper.style.transform = `translateX(-${currentIndex * 100}%)`;

            // Update active dot
            const dots = dotsContainer.querySelectorAll('.dot');
            dots.forEach((dot, index) => {
                dot.classList.toggle('active', index === currentIndex);
            });

            // Update tombol navigasi
            const isSingleImage = slidesData.length <= 1;
            prevBtn.disabled = currentIndex === 0 || isSingleImage;
            nextBtn.disabled = currentIndex === slidesData.length - 1 || isSingleImage;
            prevBtn.style.display = isSingleImage ? 'none' : 'block';
            nextBtn.style.display = isSingleImage ? 'none' : 'block';
            dotsContainer.style.display = isSingleImage ? 'none' : 'block';
        }

        function goToSlide(index) {
            if (index < 0 || index >= slidesData.length) return;
            currentIndex = index;
            updateSlider();
        }

        function nextSlide() {
            if (currentIndex < slidesData.length - 1) {
                currentIndex++;
                updateSlider();
            }
        }

        function prevSlide() {
            if (currentIndex > 0) {
                currentIndex--;
                updateSlider();
            }
        }

        // Touch event handlers
        function handleTouchStart(event) {
            if (slidesData.length <= 1) return; // Jangan proses swipe jika hanya 1 gambar
            touchStartX = event.touches[0].clientX;
            touchEndX = 0; // Reset touchEndX
        }

        function handleTouchMove(event) {
            if (slidesData.length <= 1 || touchStartX === 0) return;
            touchEndX = event.touches[0].clientX;
        }

        function handleTouchEnd() {
            if (slidesData.length <= 1 || touchStartX === 0 || touchEndX === 0) return; // Jangan proses jika tidak ada swipe berarti

            const diffX = touchStartX - touchEndX;
            if (Math.abs(diffX) > swipeThreshold) { // Hanya proses jika swipe cukup jauh
                if (diffX > 0) { // Swipe ke kiri (gambar berikutnya)
                    nextSlide();
                } else { // Swipe ke kanan (gambar sebelumnya)
                    prevSlide();
                }
            }
            touchStartX = 0; // Reset setelah swipe selesai
            touchEndX = 0;
        }


        document.addEventListener('DOMContentLoaded', function() {
            sliderWrapper = document.getElementById('sliderWrapper');
            prevBtn = document.getElementById('prevBtn');
            nextBtn = document.getElementById('nextBtn');
            dotsContainer = document.getElementById('dotsContainer');
            elStatusSlider = document.getElementById('statusSlider');
            elLogPWA = document.getElementById('logOutputPWA');

            catatLogPWA("Halaman PWA Galeri Geser siap (DOMContentLoaded).");

            if (typeof window.infoStatusSlider !== 'undefined') {
                elStatusSlider.textContent = window.infoStatusSlider;
            }

            try {
                slidesData = JSON.parse(window.jsonDataGambarSlider || "[]");
            } catch (e) {
                catatLogPWA("Error parsing jsonDataGambarSlider awal: " + e);
                slidesData = [];
            }
            createSlides(); // Buat slide awal berdasarkan data dari meta

            prevBtn.addEventListener('click', prevSlide);
            nextBtn.addEventListener('click', nextSlide);

            // Tambahkan event listener untuk swipe
            sliderWrapper.addEventListener('touchstart', handleTouchStart, { passive: true });
            sliderWrapper.addEventListener('touchmove', handleTouchMove, { passive: true });
            sliderWrapper.addEventListener('touchend', handleTouchEnd);
        });

        var autoToolsUpdateValues = function(values) {
            catatLogPWA("autoToolsUpdateValues dipanggil oleh Tasker.");
            let valuesUntukLog = {...values};
            if (valuesUntukLog.jsonDataGambarSlider) valuesUntukLog.jsonDataGambarSlider = `(Data JSON Gambar - Panjang: ${values.jsonDataGambarSlider.length})`;
            catatLogPWA("Data diterima: " + JSON.stringify(valuesUntukLog));

            if (typeof values.infoStatusSlider !== 'undefined') {
                elStatusSlider.textContent = values.infoStatusSlider;
            }

            if (typeof values.jsonDataGambarSlider !== 'undefined') {
                try {
                    const newData = JSON.parse(values.jsonDataGambarSlider);
                    if (JSON.stringify(newData) !== JSON.stringify(slidesData)) { // Hanya update jika data berbeda
                        slidesData = newData;
                        currentIndex = 0; // Reset ke slide pertama saat data baru masuk
                        createSlides();
                        catatLogPWA("Data gambar slider diperbarui dari Tasker.");
                    } else {
                        catatLogPWA("Data gambar slider sama dengan yang sudah ada, tidak ada perubahan.");
                    }
                } catch (e) {
                    catatLogPWA("Error parsing jsonDataGambarSlider dari update: " + e);
                    // Mungkin tampilkan pesan error ke pengguna atau biarkan slide lama
                }
            }
        };
        catatLogPWA("Skrip PWA Galeri Geser selesai dimuat.");
    </script>
</body>
</html>
