<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>TBC Konsep V5.1 (Static JSON)</title>

    <meta name="autotoolswebscreen" type="variablejs" id="jsonDataBattle" label="Data JSON Battle" 
          defaultValue='{}' />
    <meta name="autotoolswebscreen" type="variablejs" id="infoGlobal" label="Info Global Awal" defaultValue="Memuat info global..." />

    <style>
        :root {
            --bg-main: #282c34; --text-main: #abb2bf; --bg-panel: #21252b; --border-color: #3e4451;
            --accent-blue: #61afef; --accent-green: #98c379; --accent-red: #e06c75;
            --accent-yellow: #e5c07b; --accent-purple: #c678dd; --accent-orange: #ffb86c;
        }
        body { 
            font-family: 'Verdana', sans-serif; margin: 0; background-color: var(--bg-main); 
            color: var(--text-main); display: flex; flex-direction: column; height: 100vh; overflow: hidden; 
        }
        button { font-family: inherit; }
        /* Area Atas */
        .top-info-bar { padding: 8px 12px; text-align: center; background-color: var(--bg-panel); border-bottom: 1px solid var(--border-color); }
        #round-turn-info { font-size: 0.9em; }
        #battle-message-area { padding: 8px 12px; text-align: center; min-height: 20px; font-style: italic; background-color: rgba(0,0,0,0.1); font-size: 0.85em;}
        
        /* Area Konten Utama Game (Fleksibel) */
        .game-main-content-wrapper {
            flex-grow: 1; /* Membuat wrapper ini mengambil sisa ruang */
            display: flex;
            flex-direction: column;
            overflow-y: auto; /* Jika kontennya lebih tinggi dari ruang yang tersedia */
            padding-bottom: 10px; /* Beri sedikit ruang dari pseudomap jika pseudomap di luar wrapper ini */
        }

        /* Area Musuh Utama */
        #enemy-focus-display { padding: 15px; margin: 10px auto; width: calc(100% - 40px); max-width: 350px; background-color: var(--bg-panel); border-radius: 8px; text-align: center; border: 2px solid var(--border-color); transition: border-color 0.2s, box-shadow 0.2s; }
        #enemy-focus-display.targetable { cursor: pointer; border-color: var(--accent-orange); }
        #enemy-focus-display.selected-target { border-color: var(--accent-red); box-shadow: 0 0 10px var(--accent-red); }
        #focused-enemy-name-text { font-size: 1.1em; font-weight: bold; color: var(--accent-blue); margin-bottom: 5px; }
        #focused-enemy-hp-text { font-size: 0.9em; }
        
        /* PseudoMap */
        #pseudomap-container { 
            width: 100%; background-color: var(--bg-panel); padding: 8px 0; 
            overflow-x: auto; white-space: nowrap; text-align: center; 
            border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); 
            /* margin-top: auto; /* Dihapus sementara untuk melihat apakah ini penyebabnya */
            min-height: 70px; /* DEBUG: pastikan container terlihat */
            border: 2px dashed red; /* DEBUG: pastikan container terlihat */
        }
        .pseudomap-unit-item { 
            display: inline-block; background-color: var(--bg-main); border: 1px solid var(--border-color); 
            padding: 6px 10px; margin: 0 3px; border-radius: 4px; text-align: center; 
            min-width: 75px; font-size: 0.75em; transition: transform 0.2s, border-color 0.2s; 
        }
        .pseudomap-unit-item.active-turn-unit { border-color: var(--accent-green); transform: scale(1.05); font-weight: bold; }
        .pseudomap-unit-item.targetable-in-map { cursor: pointer; border-color: var(--accent-orange) !important; }
        .pseudomap-unit-item.selected-in-map { border-color: var(--accent-red) !important; box-shadow: 0 0 8px var(--accent-red); }
        .pseudomap-unit-item.ally-unit { border-left: 3px solid var(--accent-blue); }
        .pseudomap-unit-item.enemy-unit { border-left: 3px solid var(--accent-red); }
        .pseudomap-unit-item .unit-name-text { display: block; color: var(--text-main); }
        .pseudomap-unit-item .unit-hp-text { font-size: 0.9em; color: var(--accent-yellow); }
        
        /* Panel Perintah Pertempuran (Bawah) */
        #battle-command-panel { 
            background-color: var(--bg-panel); padding: 10px; border-top: 1px solid var(--border-color); 
            width: 100%; box-sizing: border-box; text-align: center; 
            /* position: fixed; bottom: 0; left: 0; /* Dihapus sementara untuk melihat apakah ini mengganggu pseudomap */
            /* Jika tidak fixed, pastikan ini adalah item terakhir di body flex column */
        }
        .active-hero-info-display { margin-bottom: 10px; cursor: pointer; } /* Made clickable */
        .active-hero-info-display .name { font-size: 1.2em; font-weight: bold; color: var(--accent-green); }
        .active-hero-info-display .hp { font-size: 0.9em; }
        .action-buttons-container button { background-color: var(--accent-purple); color: #f8f8f2; border: none; padding: 10px 15px; margin: 5px; font-size: 0.9em; border-radius: 5px; cursor: pointer; min-width: 80px; }
        .action-buttons-container button.ultimate-btn { background-color: var(--accent-yellow); color: var(--bg-main); }
        .action-buttons-container button:disabled { background-color: #555; color: #888; cursor: not-allowed; }
        #team-sp-indicator { margin-top: 8px; font-size: 0.9em; }
        
        /* Panel Deskripsi (awalnya tersembunyi) */
        #description-panel-overlay { 
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background-color: rgba(30, 30, 40, 0.95); color: #f0f0f0; 
            padding: 15px; box-sizing: border-box; z-index: 100; 
            border-top: 2px solid var(--accent-yellow); 
            transition: transform 0.3s ease-out; transform: translateY(100%); 
        }
        #description-panel-overlay.visible { transform: translateY(0); }
        #description-panel-overlay h3 { margin-top: 0; color: var(--accent-yellow); }
        #description-panel-content-area { font-size: 0.85em; max-height: 100px; overflow-y: auto; }
        #close-description-button { display: block; margin: 10px auto 0 auto; padding: 8px 15px; background-color: var(--accent-red); color:white; border:none; border-radius:4px; }

        .is-hidden { display: none !important; }
        .pwa-log-display-area { 
            position: fixed; bottom: 0; right:0; width: 40%; 
            background-color: rgba(0,0,0,0.7); color: #0f0; font-size:0.6em; /* Sedikit lebih besar */
            max-height: 120px; /* Lebih tinggi */ overflow-y:auto; padding: 5px; 
            box-sizing: border-box; z-index: 1001; opacity: 0.85; border-left: 1px solid #0f0; border-top: 1px solid #0f0;
        }
        .pwa-log-display-area pre { margin:0; white-space: pre-wrap; word-break: break-all; }
    </style>
</head>
<body>
    <div class="top-info-bar">
        <span id="round-turn-info">Ronde: - Turn: -</span>
    </div>
    <div id="battle-message-area">Memuat pesan...</div>

    <div class="game-main-content-wrapper">
        <div id="enemy-focus-display">
            <div id="focused-enemy-name-text">Musuh</div>
            <div id="focused-enemy-hp-text">HP: -/-</div>
        </div>
    </div>

    <div id="pseudomap-container">
        <div id="pseudomap-strip">
            </div>
    </div>

    <div id="battle-command-panel">
        <div id="active-hero-display-info" class="is-hidden">
            <span class="name">Nama Hero Aktif</span> (<span class="hp">HP: -/-</span>)<br>
            <span class="gauge">Gauge: -/-</span>
        </div>
        <div id="action-buttons-list" class="action-buttons-container is-hidden">
            <button id="btn-normal-attack">Attack</button>
            <button id="btn-unique-skill">Skill</button>
            <button id="btn-ultimate-skill" class="ultimate-btn">Ultimate</button>
            <button id="btn-cancel-action" style="background-color: #777;">Batal</button>
        </div>
        <div id="team-sp-indicator">SP Tim: -/-</div>
    </div>

    <div id="description-panel-overlay">
        <h3 id="description-title-text">Deskripsi</h3>
        <div id="description-panel-content-area">Konten deskripsi akan muncul di sini...</div>
        <button id="close-description-button">Tutup</button>
    </div>

    <div class="pwa-log-display-area">
        <strong>Log PWA:</strong>
        <pre id="pwaLogOutputArea"></pre>
    </div>

    <script type="text/javascript">
        // --- State PWA ---
        let bState = {}; 
        let pwaMode = "idle"; // Mode awal adalah idle
        let selectedAction = { type: null, id: null, name: null, spCost: 0, targetType: null, desc: "" };
        let focusedEnemyIdxPWA = 0;
        let activeHeroPWA = null;

        // --- Referensi Elemen DOM ---
        let elRoundTurn, elBattleMsg, elEnemyFocus, elFocusedEnemyName, elFocusedEnemyHp;
        let elPseudomapStrip, elCmdPanelActiveHeroInfo, elActiveHeroName, elActiveHeroHp, elActiveHeroGauge;
        let elCmdPanelActionButtons, elBtnAtk, elBtnSkill, elBtnUlt, elBtnCancelAction;
        let elTeamSpDisplay, elDescPanelOverlay, elDescTitleText, elDescContentArea, elCloseDescBtn, elPwaLog;

        function pwaLogger(msg) { 
            if(elPwaLog) {
                const timestamp = new Date().toLocaleTimeString().split(" ")[0];
                elPwaLog.textContent += `[${timestamp}] ${msg}\n`; 
                elPwaLog.scrollTop = elPwaLog.scrollHeight;
            } 
            console.log(`[PWA LOG] ${msg}`); 
        }

        // --- Fungsi Update UI ---
        function renderFocusedEnemy() {
            if (!bState.Units || bState.Units.length === 0) {
                if(elFocusedEnemyName) elFocusedEnemyName.textContent = "Tidak ada musuh."; 
                if(elFocusedEnemyHp) elFocusedEnemyHp.textContent = ""; 
                return;
            }
            const livingEnemies = bState.Units.filter(u => u.Type === "Enemy" && u.Stats.HP > 0);
            if (livingEnemies.length === 0) {
                if(elFocusedEnemyName) elFocusedEnemyName.textContent = "Musuh Habis!"; 
                if(elFocusedEnemyHp) elFocusedEnemyHp.textContent = ""; 
                return;
            }
            focusedEnemyIdxPWA = Math.max(0, Math.min(focusedEnemyIdxPWA, livingEnemies.length - 1));
            const enemy = livingEnemies[focusedEnemyIdxPWA];
            if (enemy) {
                if(elFocusedEnemyName) elFocusedEnemyName.textContent = enemy.Name;
                if(elFocusedEnemyHp) elFocusedEnemyHp.textContent = `HP: ${enemy.Stats.HP}/${enemy.Stats.MaxHP}`;
            } else {
                if(elFocusedEnemyName) elFocusedEnemyName.textContent = "-"; 
                if(elFocusedEnemyHp) elFocusedEnemyHp.textContent = "-/-";
            }
        }

        function renderPseudomap() {
            pwaLogger(`Memulai renderPseudomap. Ada ${bState.Units ? bState.Units.length : '0'} unit.`);
            if (!elPseudomapStrip) {
                pwaLogger("ERROR: elPseudomapStrip adalah null!");
                return;
            }
            elPseudomapStrip.innerHTML = ""; // Kosongkan strip
            if (!bState.Units) {
                pwaLogger("renderPseudomap: bState.Units kosong atau tidak terdefinisi.");
                elPseudomapStrip.innerHTML = "<div>Data unit tidak tersedia.</div>";
                return;
            }
            if (bState.Units.length === 0) {
                pwaLogger("renderPseudomap: bState.Units adalah array kosong.");
                elPseudomapStrip.innerHTML = "<div>Tidak ada unit dalam battle.</div>";
                return;
            }

            // JSON sudah diurutkan berdasarkan PseudoPos oleh Tasker (atau statis dalam kasus ini)
            bState.Units.forEach(unit => { 
                const item = document.createElement('div');
                item.classList.add('pseudomap-unit-item', unit.Type === "Ally" ? 'ally-unit' : 'enemy-unit');
                item.dataset.unitId = unit.id;
                // Hanya tampilkan nama dan HP untuk saat ini
                item.innerHTML = `<span class="unit-name-text">${unit.Name}</span><span class="unit-hp-text">HP: ${unit.Stats.HP}</span>`;

                if (unit.Status === "Active") { // Gunakan Status untuk menandai unit aktif
                    item.classList.add('active-turn-unit');
                }
                
                if (pwaMode === "targeting" && unit.Stats.HP > 0) {
                    let isValidTarget = false;
                    if (selectedAction.targetType === "MusuhTunggal" && unit.Type === "Enemy") isValidTarget = true;
                    if (selectedAction.targetType === "AllyTunggal" && unit.Type === "Ally") isValidTarget = true;
                    
                    if (isValidTarget) {
                        item.classList.add('targetable-in-map');
                        item.onclick = () => handleTargetSelectionInMap(unit);
                    } else {
                        item.style.opacity = "0.5"; item.style.filter = "grayscale(80%)";
                    }
                }
                elPseudomapStrip.appendChild(item);
            });
            pwaLogger(`renderPseudomap selesai. ${bState.Units.length} unit dirender.`);
        }
        
        function renderCommandPanel() {
            activeHeroPWA = bState.Units && bState.Units.find(u => u.Status === "Active" && u.Type === "Ally");
            if (!activeHeroPWA && bState.ActiveUnitID) { // Fallback jika tidak ada yang Status "Active"
                 activeHeroPWA = bState.Units && bState.Units.find(u => u.id === bState.ActiveUnitID && u.Type === "Ally");
            }
            pwaLogger(`renderCommandPanel: activeHeroPWA = ${activeHeroPWA ? activeHeroPWA.Name : 'null'}, pwaMode = ${pwaMode}`);

            if (pwaMode === "player_action_pending" && activeHeroPWA) {
                if(elCmdPanelActiveHeroInfo) elCmdPanelActiveHeroInfo.classList.add('is-hidden');
                if(elCmdPanelActionButtons) elCmdPanelActionButtons.classList.remove('is-hidden');
                
                pwaLogger("renderCommandPanel: Menampilkan Tombol Aksi. Visibilitas #action-buttons-list: " + (elCmdPanelActionButtons ? window.getComputedStyle(elCmdPanelActionButtons).display : 'elCmdPanelActionButtons null'));

                if(elBtnSkill && activeHeroPWA.Skills) elBtnSkill.textContent = activeHeroPWA.Skills.uniqueSkillName || "Skill";
                else if(elBtnSkill) elBtnSkill.textContent = "Skill"; 

                if(elBtnUlt && activeHeroPWA.Skills) elBtnUlt.textContent = activeHeroPWA.Skills.ultimateName || "Ultimate";
                else if(elBtnUlt) elBtnUlt.textContent = "Ultimate";

                if(elBtnUlt) elBtnUlt.disabled = (activeHeroPWA.CurrentGauge || 0) < (activeHeroPWA.MaxGauge || 100);

            } else if (activeHeroPWA && bState.BattleState === "Ongoing" && pwaMode !== "targeting" && pwaMode !== "showing_description_for_action") {
                if(elCmdPanelActiveHeroInfo) elCmdPanelActiveHeroInfo.classList.remove('is-hidden');
                if(elCmdPanelActionButtons) elCmdPanelActionButtons.classList.add('is-hidden');
                if(elActiveHeroName) elActiveHeroName.textContent = activeHeroPWA.Name;
                if(elActiveHeroHp) elActiveHeroHp.textContent = `HP: ${activeHeroPWA.Stats.HP}/${activeHeroPWA.Stats.MaxHP}`;
                if(elActiveHeroGauge) elActiveHeroGauge.textContent = `Gauge: ${activeHeroPWA.CurrentGauge || 0}/${activeHeroPWA.MaxGauge || 100}`;
                pwaLogger("renderCommandPanel: Menampilkan Info Hero Aktif.");
            } else {
                if(elCmdPanelActiveHeroInfo) elCmdPanelActiveHeroInfo.classList.add('is-hidden');
                if(elCmdPanelActionButtons) elCmdPanelActionButtons.classList.add('is-hidden');
                pwaLogger(`renderCommandPanel: Menyembunyikan kedua panel. pwaMode: ${pwaMode}, activeHeroPWA: ${activeHeroPWA ? activeHeroPWA.Name : 'null'}`);
            }

            if(elTeamSpDisplay) elTeamSpDisplay.textContent = `SP Tim: ${bState.TeamSP !== undefined ? bState.TeamSP : '-'}/${bState.MaxTeamSP !== undefined ? bState.MaxTeamSP : '-'}`;
        }

        function showDescriptionPanel(title, content) {
            if(elDescTitleText) elDescTitleText.textContent = title;
            if(elDescContentArea) elDescContentArea.textContent = content;
            if(elDescPanelOverlay) elDescPanelOverlay.classList.add('visible');
            if(elTeamSpDisplay) elTeamSpDisplay.classList.add('is-hidden');
            if(elBattleMsg) elBattleMsg.classList.add('is-hidden');
            pwaLogger(`Deskripsi ditampilkan: ${title}`);
        }
        function hideDescriptionPanel() {
            if(elDescPanelOverlay) elDescPanelOverlay.classList.remove('visible');
            if(elTeamSpDisplay) elTeamSpDisplay.classList.remove('is-hidden');
            if(elBattleMsg) elBattleMsg.classList.remove('is-hidden');
            pwaLogger("Deskripsi ditutup.");
        }
        
        function selectActionForTargeting(actionType, skillDetails) {
            pwaLogger(`Aksi dipilih: ${actionType} - ${skillDetails.name || 'N/A'}`);
            selectedAction = { 
                type: actionType, 
                id: skillDetails.id || (actionType === 'normalAttack' ? 'normalAttack' : null), 
                name: skillDetails.name, 
                spCost: skillDetails.spCost || 0, 
                targetType: skillDetails.targetType || "MusuhTunggal",
                desc: skillDetails.desc
            };
            pwaMode = "targeting";
            
            showDescriptionPanel(selectedAction.name, selectedAction.desc + (selectedAction.spCost > 0 ? ` (Biaya: ${selectedAction.spCost} SP)`: ""));
            
            if(elBattleMsg) elBattleMsg.textContent = `Pilih target di Peta untuk ${selectedAction.name}...`;
            if(elCmdPanelActionButtons) elCmdPanelActionButtons.classList.add('is-hidden'); 
            refreshAllUIElements(); 
        }

        function confirmTargetAndSendCommand(targetUnit) {
            pwaLogger(`Target dipilih di Peta: ${targetUnit.Name} (ID: ${targetUnit.id}) untuk aksi ${selectedAction.name}`);
            hideDescriptionPanel(); 
            
            const targetItemInMap = elPseudomapStrip ? elPseudomapStrip.querySelector(`.pseudomap-unit-item[data-unit-id="${targetUnit.id}"]`) : null;
            if(targetItemInMap) targetItemInMap.classList.add('selected-in-map');

            if (window.AutoTools && typeof window.AutoTools.sendCommand === 'function') {
                const command = `actorId=${activeHeroPWA.id}&actionType=${selectedAction.type}&actionId=${selectedAction.id}&targetId=${targetUnit.id}`;
                window.AutoTools.sendCommand(command, "TBC_AKSI_PEMAIN", false);
                pwaLogger("Kirim command ke Tasker: " + command);
            } else { pwaLogger("AutoTools.sendCommand tidak tersedia."); }
            
            pwaMode = "idle";
            if(elBattleMsg) elBattleMsg.textContent = "Aksi dikirim ke Tasker...";
            // UI akan diupdate dari Tasker
        }

        function refreshAllUIElements() {
            pwaLogger("Memulai refreshAllUIElements. Mode PWA: " + pwaMode);
            if (!bState || Object.keys(bState).length === 0 || !bState.Units) { 
                pwaLogger("refreshAllUIElements: Data battle (bState atau bState.Units) kosong atau tidak valid.");
                if(elRoundTurn) elRoundTurn.textContent = "Ronde: - Turn: -";
                if(elBattleMsg && (!elDescPanelOverlay || !elDescPanelOverlay.classList.contains('visible'))) elBattleMsg.textContent = "Data tidak tersedia...";
                if(elFocusedEnemyName) elFocusedEnemyName.textContent = "-";
                if(elFocusedEnemyHp) elFocusedEnemyHp.textContent = "HP: -/-";
                if(elPseudomapStrip) elPseudomapStrip.innerHTML = "<div>Tidak ada unit data.</div>";
                if(elCmdPanelActiveHeroInfo) elCmdPanelActiveHeroInfo.classList.add('is-hidden');
                if(elCmdPanelActionButtons) elCmdPanelActionButtons.classList.add('is-hidden');
                if(elTeamSpDisplay) elTeamSpDisplay.textContent = "SP Tim: -/-";
                return; 
            }
            
            if(elRoundTurn) elRoundTurn.textContent = `Ronde: ${bState.Round || '-'} Turn: ${bState.Turn || '-'}`;
            if(elBattleMsg && (!elDescPanelOverlay || !elDescPanelOverlay.classList.contains('visible'))) elBattleMsg.textContent = bState.BattleMessage || "Menunggu...";
            
            renderPseudomap(); // Render pseudomap dulu
            renderFocusedEnemy();
            renderCommandPanel(); // Render panel perintah setelahnya

            pwaLogger("UI direfresh sepenuhnya. Mode PWA: " + pwaMode);
        }

        // --- Inisialisasi ---
        document.addEventListener('DOMContentLoaded', () => {
            elRoundTurn = document.getElementById('round-turn-info');
            elBattleMsg = document.getElementById('battle-message-area');
            elEnemyFocus = document.getElementById('enemy-focus-display');
            elFocusedEnemyName = document.getElementById('focused-enemy-name-text');
            elFocusedEnemyHp = document.getElementById('focused-enemy-hp-text');
            elPseudomapStrip = document.getElementById('pseudomap-strip');
            elCmdPanelActiveHeroInfo = document.getElementById('active-hero-display-info');
            if (elCmdPanelActiveHeroInfo) { // Pastikan elemen ada sebelum querySelector
                elActiveHeroName = elCmdPanelActiveHeroInfo.querySelector('.name');
                elActiveHeroHp = elCmdPanelActiveHeroInfo.querySelector('.hp');
                elActiveHeroGauge = elCmdPanelActiveHeroInfo.querySelector('.gauge');
            } else { pwaLogger("ERROR: #active-hero-display-info tidak ditemukan!"); }
            
            elCmdPanelActionButtons = document.getElementById('action-buttons-list');
            elBtnAtk = document.getElementById('btn-normal-attack');
            elBtnSkill = document.getElementById('btn-unique-skill');
            elBtnUlt = document.getElementById('btn-ultimate-skill');
            elBtnCancelAction = document.getElementById('btn-cancel-action');
            elTeamSpDisplay = document.getElementById('team-sp-indicator');
            elDescPanelOverlay = document.getElementById('description-panel-overlay');
            elDescTitleText = document.getElementById('description-title-text');
            elDescContentArea = document.getElementById('description-panel-content-area');
            elCloseDescBtn = document.getElementById('close-description-button');
            elPwaLog = document.getElementById('pwaLogOutputArea');

            pwaLogger("PWA TBC V5.1 Siap (DOM Loaded).");

            try { 
                if (window.jsonDataBattle && typeof window.jsonDataBattle === 'string') {
                    bState = JSON.parse(window.jsonDataBattle); 
                    pwaLogger("Data awal JSON dari meta berhasil diparsing.");
                } else if (window.jsonDataBattle) { // Jika bukan string tapi ada
                    bState = window.jsonDataBattle; // Asumsikan sudah objek
                    pwaLogger("Data awal JSON dari meta adalah objek, digunakan langsung.");
                } else {
                    bState = {}; // Default kosong jika tidak ada
                    pwaLogger("Tidak ada jsonDataBattle di window, bState diinisialisasi kosong.");
                }
            } catch (e) { 
                pwaLogger("Error parsing JSON awal dari meta: " + e + ". Data mentah: " + window.jsonDataBattle); 
                bState = { Units: [], BattleMessage: "Error data awal." }; 
            }
            
            if (window.infoGlobal && elBattleMsg) {
                if (!bState.BattleMessage) {
                     elBattleMsg.textContent = window.infoGlobal;
                     pwaLogger(`Menggunakan infoGlobal dari meta: "${window.infoGlobal}"`);
                }
            }
            
            refreshAllUIElements(); // Refresh UI dengan data awal

            // Event Listener untuk tap hero di panel bawah
            if(elCmdPanelActiveHeroInfo) {
                elCmdPanelActiveHeroInfo.addEventListener('click', () => {
                    activeHeroPWA = bState.Units && bState.Units.find(u => u.Status === "Active" && u.Type === "Ally"); // Pastikan activeHeroPWA terupdate
                    if (pwaMode === "idle" && activeHeroPWA) { // Hanya jika mode idle dan ada hero aktif
                        pwaMode = "player_action_pending";
                        pwaLogger("Panel Info Hero Aktif di-tap. Mode diubah ke: player_action_pending.");
                        refreshAllUIElements(); 
                    } else {
                        pwaLogger(`Tap di Panel Info Hero diabaikan. Mode: ${pwaMode}, Hero Aktif: ${activeHeroPWA ? activeHeroPWA.Name : 'Tidak ada'}`);
                    }
                });
            }

            // Event Listeners untuk Tombol Aksi
            if(elBtnAtk) elBtnAtk.addEventListener('click', () => {
                if (!activeHeroPWA || !activeHeroPWA.Skills) { pwaLogger("Attack gagal: Hero atau skills tidak ada."); return; }
                selectActionForTargeting('normalAttack', {
                    name: activeHeroPWA.Skills.normalAttackName || "Serang Biasa",
                    desc: activeHeroPWA.Skills.normalAttackDesc || "Serangan fisik standar.",
                    targetType: "MusuhTunggal" 
                });
            });
            if(elBtnSkill) elBtnSkill.addEventListener('click', () => {
                if (!activeHeroPWA || !activeHeroPWA.Skills) { pwaLogger("Skill gagal: Hero atau skills tidak ada."); return; }
                const spCost = activeHeroPWA.Skills.uniqueSkillSpCost || 0;
                if (bState.TeamSP >= spCost ) {
                    selectActionForTargeting('uniqueSkill', {
                        id: activeHeroPWA.Skills.uniqueSkillId,
                        name: activeHeroPWA.Skills.uniqueSkillName || "Skill Unik",
                        spCost: spCost,
                        targetType: activeHeroPWA.Skills.uniqueSkillTargetType || "MusuhTunggal",
                        desc: activeHeroPWA.Skills.uniqueSkillDesc || "Efek skill unik."
                    });
                } else {
                    pwaLogger(`SP Tim tidak cukup untuk Skill! Butuh: ${spCost}, Punya: ${bState.TeamSP}`);
                    alert(`SP Tim tidak cukup! Butuh: ${spCost}, Punya: ${bState.TeamSP}`); 
                }
            });
            if(elBtnUlt) elBtnUlt.addEventListener('click', () => {
                 if (!activeHeroPWA || !activeHeroPWA.Skills) { pwaLogger("Ultimate gagal: Hero atau skills tidak ada."); return; }
                 if ((activeHeroPWA.CurrentGauge || 0) >= (activeHeroPWA.MaxGauge || 100)) {
                    selectActionForTargeting('ultimateSkill', {
                        name: activeHeroPWA.Skills.ultimateName || "Ultimate",
                        targetType: activeHeroPWA.Skills.ultimateTargetType || "MusuhTunggal",
                        desc: activeHeroPWA.Skills.ultimateDesc || "Serangan pamungkas."
                    });
                 } else {
                    pwaLogger("Gauge Ultimate belum penuh!");
                    alert("Gauge Ultimate belum penuh!");
                 }
            });
            if(elBtnCancelAction) elBtnCancelAction.addEventListener('click', () => {
                pwaMode = "idle";
                hideDescriptionPanel();
                pwaLogger("Aksi dibatalkan oleh pemain. Mode diubah ke: idle.");
                refreshAllUIElements();
            });

            if(elCloseDescBtn) elCloseDescBtn.addEventListener('click', hideDescriptionPanel);
            
            if(elEnemyFocus) elEnemyFocus.addEventListener('click', () => {
                if (pwaMode === "idle" && bState.Units) {
                    const livingEnemies = bState.Units.filter(u => u.Type === "Enemy" && u.Stats.HP > 0);
                    if (livingEnemies.length > 0 && focusedEnemyIdxPWA < livingEnemies.length) {
                        const enemy = livingEnemies[focusedEnemyIdxPWA];
                        showDescriptionPanel(`Info Musuh: ${enemy.Name}`, `HP: ${enemy.Stats.HP}/${enemy.Stats.MaxHP}\nATK: ${enemy.Stats.ATK || 'N/A'}\n(Detail buff/debuff akan ada di sini)`);
                    }
                }
            });

            let enemySwipeStartX = 0;
            if(elEnemyFocus) {
                elEnemyFocus.addEventListener('touchstart', (e) => { enemySwipeStartX = e.touches[0].clientX; }, { passive: true });
                elEnemyFocus.addEventListener('touchend', (e) => {
                    if (pwaMode !== "idle") return; 
                    let enemySwipeEndX = e.changedTouches[0].clientX;
                    const livingEnemies = bState.Units ? bState.Units.filter(u => u.Type === "Enemy" && u.Stats.HP > 0) : [];
                    if (Math.abs(enemySwipeStartX - enemySwipeEndX) > 30 && livingEnemies.length > 1) {
                        if (enemySwipeEndX < enemySwipeStartX) { 
                            focusedEnemyIdxPWA = (focusedEnemyIdxPWA + 1) % livingEnemies.length;
                        } else { 
                            focusedEnemyIdxPWA = (focusedEnemyIdxPWA - 1 + livingEnemies.length) % livingEnemies.length;
                        }
                        renderFocusedEnemy(); 
                        pwaLogger(`Musuh difokuskan (swipe): ${livingEnemies[focusedEnemyIdxPWA].Name}`);
                    }
                }, { passive: true });
            }
        });

        // Fungsi ini akan dipanggil oleh Tasker untuk mengupdate data
        var autoToolsUpdateValues = function(values) {
            pwaLogger("autoToolsUpdateValues dipanggil oleh Tasker.");
            let logValues = {...values};
            if(logValues.jsonDataBattle && typeof logValues.jsonDataBattle === 'string') {
                logValues.jsonDataBattle = `(JSON diterima - panjang: ${values.jsonDataBattle.length})`;
            } else if (logValues.jsonDataBattle) {
                logValues.jsonDataBattle = `(Data objek diterima)`;
            }
            pwaLogger("Data dari Tasker: " + JSON.stringify(logValues));

            if (values.infoGlobal && elBattleMsg) {
                elBattleMsg.textContent = values.infoGlobal;
            }

            if (values.jsonDataBattle) {
                let newBState;
                try {
                    if (typeof values.jsonDataBattle === 'string') {
                        newBState = JSON.parse(values.jsonDataBattle);
                    } else {
                        newBState = values.jsonDataBattle; // Asumsikan sudah objek
                    }

                    if (JSON.stringify(bState) !== JSON.stringify(newBState)) {
                        bState = newBState;
                        pwaMode = "idle"; // Reset mode ke idle setiap ada update besar dari Tasker
                        hideDescriptionPanel(); 
                        refreshAllUIElements();
                        pwaLogger("State battle PWA berhasil diupdate dari Tasker.");
                    } else {
                        pwaLogger("Data JSON dari Tasker sama dengan state saat ini, tidak ada update UI besar.");
                        if (values.infoGlobal && elBattleMsg && elBattleMsg.textContent !== values.infoGlobal) {
                           elBattleMsg.textContent = values.infoGlobal;
                        }
                    }
                } catch (e) {
                    pwaLogger("Error parsing jsonDataBattle dari update Tasker: " + e);
                }
            }
        };
        pwaLogger("Skrip PWA TBC V5.1 selesai dimuat.");
    </script>
</body>
</html>
