<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>TBC Konsep V5.2 (PseudoMap Tengah)</title>

    <meta name="autotoolswebscreen" type="variablejs" id="jsonDataBattle" label="Data JSON Battle" defaultValue='{}' />
    <meta name="autotoolswebscreen" type="variablejs" id="infoGlobal" label="Info Global Awal" defaultValue="Memuat info global..." />

    <style>
        :root {
            --bg-main: #282c34; --text-main: #abb2bf; --bg-panel: #21252b; --border-color: #3e4451;
            --accent-blue: #61afef; --accent-green: #98c379; --accent-red: #e06c75;
            --accent-yellow: #e5c07b; --accent-purple: #c678dd; --accent-orange: #ffb86c;
            --placeholder-bg: #3a3f4b;
        }
        body { 
            font-family: 'Verdana', sans-serif; margin: 0; background-color: var(--bg-main); 
            color: var(--text-main); display: flex; flex-direction: column; height: 100vh; overflow: hidden; 
        }
        button { font-family: inherit; }
        .top-info-bar { padding: 8px 12px; text-align: center; background-color: var(--bg-panel); border-bottom: 1px solid var(--border-color); }
        #round-turn-info { font-size: 0.9em; }
        #battle-message-area { padding: 8px 12px; text-align: center; min-height: 20px; font-style: italic; background-color: rgba(0,0,0,0.1); font-size: 0.85em;}
        
        .game-main-content-wrapper {
            flex-grow: 1; display: flex; flex-direction: column;
            overflow-y: auto; padding-bottom: 10px; 
        }
        #enemy-focus-display { padding: 15px; margin: 10px auto; width: calc(100% - 40px); max-width: 350px; background-color: var(--bg-panel); border-radius: 8px; text-align: center; border: 2px solid var(--border-color); }
        #focused-enemy-name-text { font-size: 1.1em; font-weight: bold; color: var(--accent-blue); margin-bottom: 5px; }
        #focused-enemy-hp-text { font-size: 0.9em; }
        
        #pseudomap-container { 
            width: 100%; background-color: var(--bg-panel); padding: 10px 0; 
            overflow-x: auto; white-space: nowrap; text-align: center; 
            border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); 
            min-height: 80px; /* Adjusted for potentially taller items */
            box-sizing: border-box;
        }
        #pseudomap-strip {
            display: flex; /* Use flexbox for centering and spacing */
            justify-content: center;
            align-items: center;
        }
        .pseudomap-unit-item, .pseudomap-placeholder-item { 
            display: inline-flex; /* Make items flex containers for content alignment */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: var(--bg-main); border: 1px solid var(--border-color); 
            padding: 6px 10px; margin: 0 4px; /* Increased margin slightly */
            border-radius: 6px; /* Slightly more rounded */
            width: 85px; /* Fixed width for consistency */
            height: 60px; /* Fixed height */
            box-sizing: border-box;
            font-size: 0.7em; /* Smaller font for more info */
            transition: transform 0.2s, border-color 0.2s, box-shadow 0.2s; 
        }
        .pseudomap-placeholder-item {
            background-color: var(--placeholder-bg);
            border-style: dashed;
        }
        .pseudomap-unit-item.active-turn-unit { 
            border-color: var(--accent-green); transform: scale(1.08); font-weight: bold; 
            box-shadow: 0 0 8px var(--accent-green);
        }
        .pseudomap-unit-item.targetable-in-map { cursor: pointer; border-color: var(--accent-orange) !important; }
        .pseudomap-unit-item.selected-in-map { border-color: var(--accent-red) !important; box-shadow: 0 0 8px var(--accent-red); }
        .pseudomap-unit-item.ally-unit { border-left: 4px solid var(--accent-blue); }
        .pseudomap-unit-item.enemy-unit { border-left: 4px solid var(--accent-red); }
        .pseudomap-unit-item .unit-name-text { display: block; color: var(--text-main); font-weight: bold; margin-bottom: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%;}
        .pseudomap-unit-item .unit-hp-text { font-size: 0.9em; color: var(--accent-yellow); }
        .pseudomap-unit-item.grayscale { filter: grayscale(80%); opacity: 0.6; }


        #battle-command-panel { 
            background-color: var(--bg-panel); padding: 10px; border-top: 1px solid var(--border-color); 
            width: 100%; box-sizing: border-box; text-align: center; 
        }
        .active-hero-info-display { margin-bottom: 10px; cursor: pointer; }
        .active-hero-info-display .name { font-size: 1.2em; font-weight: bold; color: var(--accent-green); }
        .active-hero-info-display .hp { font-size: 0.9em; }
        .action-buttons-container button { background-color: var(--accent-purple); color: #f8f8f2; border: none; padding: 10px 15px; margin: 5px; font-size: 0.9em; border-radius: 5px; cursor: pointer; min-width: 80px; }
        .action-buttons-container button.ultimate-btn { background-color: var(--accent-yellow); color: var(--bg-main); }
        .action-buttons-container button:disabled { background-color: #555; color: #888; cursor: not-allowed; }
        #team-sp-indicator { margin-top: 8px; font-size: 0.9em; }
        
        #description-panel-overlay { position: fixed; bottom: 0; left: 0; width: 100%; background-color: rgba(30, 30, 40, 0.95); color: #f0f0f0; padding: 15px; box-sizing: border-box; z-index: 100; border-top: 2px solid var(--accent-yellow); transition: transform 0.3s ease-out; transform: translateY(100%); }
        #description-panel-overlay.visible { transform: translateY(0); }
        #description-panel-overlay h3 { margin-top: 0; color: var(--accent-yellow); }
        #description-panel-content-area { font-size: 0.85em; max-height: 100px; overflow-y: auto; }
        #close-description-button { display: block; margin: 10px auto 0 auto; padding: 8px 15px; background-color: var(--accent-red); color:white; border:none; border-radius:4px; }

        .is-hidden { display: none !important; }
        .pwa-log-display-area { position: fixed; bottom: 0; right:0; width: 40%; background-color: rgba(0,0,0,0.7); color: #0f0; font-size:0.6em; max-height: 120px; overflow-y:auto; padding: 5px; box-sizing: border-box; z-index: 1001; opacity: 0.85; border-left: 1px solid #0f0; border-top: 1px solid #0f0;}
        .pwa-log-display-area pre { margin:0; white-space: pre-wrap; word-break: break-all; }
    </style>
</head>
<body>
    <div class="top-info-bar">
        <span id="round-turn-info">Ronde: - Turn: -</span>
    </div>
    <div id="battle-message-area">Memuat pesan...</div>

    <div class="game-main-content-wrapper">
        <div id="enemy-focus-display">
            <div id="focused-enemy-name-text">Musuh</div>
            <div id="focused-enemy-hp-text">HP: -/-</div>
        </div>
    </div>

    <div id="pseudomap-container">
        <div id="pseudomap-strip">
            </div>
    </div>

    <div id="battle-command-panel">
        <div id="active-hero-display-info" class="is-hidden">
            <span class="name">Nama Hero Aktif</span> (<span class="hp">HP: -/-</span>)<br>
            <span class="gauge">Gauge: -/-</span>
        </div>
        <div id="action-buttons-list" class="action-buttons-container is-hidden">
            <button id="btn-normal-attack">Attack</button>
            <button id="btn-unique-skill">Skill</button>
            <button id="btn-ultimate-skill" class="ultimate-btn">Ultimate</button>
            <button id="btn-cancel-action" style="background-color: #777;">Batal</button>
        </div>
        <div id="team-sp-indicator">SP Tim: -/-</div>
    </div>

    <div id="description-panel-overlay">
        <h3 id="description-title-text">Deskripsi</h3>
        <div id="description-panel-content-area">Konten deskripsi akan muncul di sini...</div>
        <button id="close-description-button">Tutup</button>
    </div>

    <div class="pwa-log-display-area">
        <strong>Log PWA:</strong>
        <pre id="pwaLogOutputArea"></pre>
    </div>

    <script type="text/javascript">
        // --- State PWA ---
        let bState = {}; 
        let pwaMode = "idle";
        let selectedAction = { type: null, id: null, name: null, spCost: 0, targetType: null, range: null, desc: "" };
        let focusedEnemyIdxPWA = 0;
        // activeHeroPWA akan diambil dari bState.Units berdasarkan ActiveUnitID atau Status Active

        // --- Referensi Elemen DOM ---
        let elRoundTurn, elBattleMsg, elEnemyFocus, elFocusedEnemyName, elFocusedEnemyHp;
        let elPseudomapStrip, elCmdPanelActiveHeroInfo, elActiveHeroName, elActiveHeroHp, elActiveHeroGauge;
        let elCmdPanelActionButtons, elBtnAtk, elBtnSkill, elBtnUlt, elBtnCancelAction;
        let elTeamSpDisplay, elDescPanelOverlay, elDescTitleText, elDescContentArea, elCloseDescBtn, elPwaLog;

        const MAX_VISIBLE_SLOTS_PSEUDOMAP = 5; // Jumlah slot yang ingin ditampilkan

        function pwaLogger(msg) { 
            if(elPwaLog) {
                const timestamp = new Date().toLocaleTimeString().split(" ")[0];
                elPwaLog.textContent += `[${timestamp}] ${msg}\n`; 
                elPwaLog.scrollTop = elPwaLog.scrollHeight;
            } 
            console.log(`[PWA LOG] ${msg}`); 
        }
        
        function getActiveHero() {
            if (!bState || !bState.Units) return null;
            if (bState.ActiveUnitID) {
                const hero = bState.Units.find(u => u.id === bState.ActiveUnitID && u.Type === "Ally");
                if (hero) return hero;
            }
            // Fallback jika ActiveUnitID tidak ada atau tidak cocok, cari berdasarkan Status
            return bState.Units.find(u => u.Status === "Active" && u.Type === "Ally");
        }


        function renderPseudomap() {
            pwaLogger(`Memulai renderPseudomap. MAX_VISIBLE_SLOTS: ${MAX_VISIBLE_SLOTS_PSEUDOMAP}`);
            if (!elPseudomapStrip) {
                pwaLogger("ERROR: elPseudomapStrip adalah null!");
                return;
            }
            elPseudomapStrip.innerHTML = ""; 

            if (!bState.Units || bState.Units.length === 0) {
                pwaLogger("renderPseudomap: bState.Units kosong.");
                for (let i = 0; i < MAX_VISIBLE_SLOTS_PSEUDOMAP; i++) {
                    const placeholder = document.createElement('div');
                    placeholder.classList.add('pseudomap-placeholder-item');
                    elPseudomapStrip.appendChild(placeholder);
                }
                return;
            }

            // Asumsi Tasker sudah mengurutkan bState.Units sehingga unit aktif (PseudoPos: 0) ada di bState.Units[0]
            // Jika tidak, kita perlu mencari unit aktif berdasarkan ActiveUnitID atau Status.
            let activeUnitInFullList = bState.Units.find(u => u.PseudoPos === 0);
            if (!activeUnitInFullList && bState.ActiveUnitID) { // Fallback jika PseudoPos 0 tidak ada
                 activeUnitInFullList = bState.Units.find(u => u.id === bState.ActiveUnitID);
            }
             if (!activeUnitInFullList && bState.Units.length > 0) { // Fallback lagi ke unit pertama jika masih tidak ada
                 activeUnitInFullList = bState.Units[0]; // Ini asumsi berisiko jika tidak diurutkan
                 pwaLogger("renderPseudomap: Tidak ada unit dengan PseudoPos 0 atau cocok ActiveUnitID, menggunakan unit pertama dari list sebagai acuan tengah.");
            }


            const displaySlots = new Array(MAX_VISIBLE_SLOTS_PSEUDOMAP).fill(null);
            const centerSlotIndex = Math.floor(MAX_VISIBLE_SLOTS_PSEUDOMAP / 2);

            if (activeUnitInFullList) {
                displaySlots[centerSlotIndex] = activeUnitInFullList;

                // Isi slot ke kanan dari unit aktif
                let currentFullListIndex = bState.Units.indexOf(activeUnitInFullList);
                for (let i = 1; i <= centerSlotIndex; i++) {
                    const targetDisplayIndex = centerSlotIndex + i;
                    if (targetDisplayIndex < MAX_VISIBLE_SLOTS_PSEUDOMAP) {
                        // Cari unit berikutnya di bState.Units yang memiliki PseudoPos positif lebih besar
                        let nextUnit = null;
                        let minPositivePseudoPosFound = Infinity;
                        // Cari unit dengan PseudoPos positif terkecil SETELAH activeUnitInFullList
                        // atau unit berikutnya secara berurutan jika PseudoPos tidak berurutan sempurna
                        let searchIdx = currentFullListIndex + 1;
                        while(searchIdx < bState.Units.length) {
                            const unit = bState.Units[searchIdx];
                            if (unit.PseudoPos > 0 && !displaySlots.includes(unit)) { // Belum ada di displaySlots
                                // Ini adalah kandidat. Untuk sementara ambil yang pertama ditemukan setelahnya.
                                // Logika yang lebih baik akan mencari PseudoPos +1, +2, dst.
                                nextUnit = unit;
                                break; 
                            }
                            searchIdx++;
                        }
                        // Untuk penyederhanaan, kita ambil unit berikutnya dalam array yang sudah diurutkan oleh PseudoPos
                        // Ini mengasumsikan bState.Units sudah diurutkan dengan benar: Negatif, 0, Positif
                        let positiveUnits = bState.Units.filter(u => u.PseudoPos > 0).sort((a,b) => a.PseudoPos - b.PseudoPos);
                        if (positiveUnits[i-1]) {
                             displaySlots[targetDisplayIndex] = positiveUnits[i-1];
                        }
                    }
                }

                // Isi slot ke kiri dari unit aktif
                for (let i = 1; i <= centerSlotIndex; i++) {
                    const targetDisplayIndex = centerSlotIndex - i;
                    if (targetDisplayIndex >= 0) {
                        let negativeUnits = bState.Units.filter(u => u.PseudoPos < 0).sort((a,b) => b.PseudoPos - a.PseudoPos); // Sort descending: -1, -2
                         if (negativeUnits[i-1]) {
                             displaySlots[targetDisplayIndex] = negativeUnits[i-1];
                        }
                    }
                }
            } else if (bState.Units.length > 0) {
                 // Jika tidak ada unit aktif yg jelas, tampilkan saja beberapa unit pertama
                 for(let i=0; i < Math.min(bState.Units.length, MAX_VISIBLE_SLOTS_PSEUDOMAP); i++) {
                     displaySlots[i] = bState.Units[i];
                 }
            }


            displaySlots.forEach(unit => {
                const item = document.createElement('div');
                if (unit) {
                    item.classList.add('pseudomap-unit-item', unit.Type === "Ally" ? 'ally-unit' : 'enemy-unit');
                    item.dataset.unitId = unit.id;
                    item.innerHTML = `<span class="unit-name-text">${unit.Name}</span><span class="unit-hp-text">HP: ${unit.Stats.HP}</span>`;

                    if (unit.id === bState.ActiveUnitID || unit.Status === "Active") {
                        item.classList.add('active-turn-unit');
                    }
                    
                    // Logika targeting highlight
                    if (pwaMode === "targeting" && unit.Stats.HP > 0) {
                        let isValidTarget = false;
                        // Contoh sederhana, perlu disesuaikan dengan detail skill (range, tipe, dll.)
                        if (selectedAction.targetType === "SingleEnemy" && unit.Type === "Enemy") isValidTarget = true;
                        else if (selectedAction.targetType === "SingleAlly" && unit.Type === "Ally") isValidTarget = true;
                        else if (selectedAction.targetType === "AllEnemies" && unit.Type === "Enemy") isValidTarget = true;
                        // Tambahkan logika lain berdasarkan selectedAction.range, dll.

                        if (isValidTarget) {
                            item.classList.add('targetable-in-map');
                            item.onclick = () => handleTargetSelectionInMap(unit);
                        } else {
                            item.classList.add('grayscale');
                        }
                    }

                } else {
                    item.classList.add('pseudomap-placeholder-item');
                }
                elPseudomapStrip.appendChild(item);
            });
            pwaLogger(`renderPseudomap selesai. ${displaySlots.filter(u => u).length} unit dirender dari ${bState.Units.length} total unit.`);
        }
        
        function renderCommandPanel() {
            const activeHero = getActiveHero();
            pwaLogger(`renderCommandPanel: activeHero = ${activeHero ? activeHero.Name : 'null'}, pwaMode = ${pwaMode}`);

            if (pwaMode === "player_action_pending" && activeHero) {
                if(elCmdPanelActiveHeroInfo) elCmdPanelActiveHeroInfo.classList.add('is-hidden');
                if(elCmdPanelActionButtons) elCmdPanelActionButtons.classList.remove('is-hidden');
                
                pwaLogger("renderCommandPanel: Menampilkan Tombol Aksi. Visibilitas #action-buttons-list: " + (elCmdPanelActionButtons ? window.getComputedStyle(elCmdPanelActionButtons).display : 'elCmdPanelActionButtons null'));

                if(elBtnSkill && activeHero.Skills) elBtnSkill.textContent = activeHero.Skills.uniqueSkillName || "Skill";
                else if(elBtnSkill) elBtnSkill.textContent = "Skill"; 

                if(elBtnUlt && activeHero.Skills) elBtnUlt.textContent = activeHero.Skills.ultimateName || "Ultimate";
                else if(elBtnUlt) elBtnUlt.textContent = "Ultimate";

                if(elBtnUlt) elBtnUlt.disabled = (activeHero.CurrentGauge || 0) < (activeHero.MaxGauge || 100);

            } else if (activeHero && bState.BattleState === "Ongoing" && pwaMode !== "targeting" && pwaMode !== "showing_description_for_action") {
                if(elCmdPanelActiveHeroInfo) elCmdPanelActiveHeroInfo.classList.remove('is-hidden');
                if(elCmdPanelActionButtons) elCmdPanelActionButtons.classList.add('is-hidden');
                if(elActiveHeroName) elActiveHeroName.textContent = activeHero.Name;
                if(elActiveHeroHp) elActiveHeroHp.textContent = `HP: ${activeHero.Stats.HP}/${activeHero.Stats.MaxHP}`;
                if(elActiveHeroGauge) elActiveHeroGauge.textContent = `Gauge: ${activeHero.CurrentGauge || 0}/${activeHero.MaxGauge || 100}`;
                pwaLogger("renderCommandPanel: Menampilkan Info Hero Aktif.");
            } else {
                if(elCmdPanelActiveHeroInfo) elCmdPanelActiveHeroInfo.classList.add('is-hidden');
                if(elCmdPanelActionButtons) elCmdPanelActionButtons.classList.add('is-hidden');
                pwaLogger(`renderCommandPanel: Menyembunyikan kedua panel.`);
            }

            if(elTeamSpDisplay) elTeamSpDisplay.textContent = `SP Tim: ${bState.TeamSP !== undefined ? bState.TeamSP : '-'}/${bState.MaxTeamSP !== undefined ? bState.MaxTeamSP : '-'}`;
        }
        
        function handleTargetSelectionInMap(targetUnit) {
            pwaLogger(`Target dipilih di Peta: ${targetUnit.Name} (ID: ${targetUnit.id}) untuk aksi ${selectedAction.name}`);
            // Di sini, PWA sudah mengidentifikasi target.
            // Langkah berikutnya adalah mengirim ini ke Tasker untuk validasi dan eksekusi.
            confirmTargetAndSendCommand(targetUnit);
        }


        function showDescriptionPanel(title, content) {
            if(elDescTitleText) elDescTitleText.textContent = title;
            if(elDescContentArea) elDescContentArea.textContent = content;
            if(elDescPanelOverlay) elDescPanelOverlay.classList.add('visible');
            if(elTeamSpDisplay) elTeamSpDisplay.classList.add('is-hidden');
            if(elBattleMsg) elBattleMsg.classList.add('is-hidden');
            pwaLogger(`Deskripsi ditampilkan: ${title}`);
        }
        function hideDescriptionPanel() {
            if(elDescPanelOverlay) elDescPanelOverlay.classList.remove('visible');
            if(elTeamSpDisplay) elTeamSpDisplay.classList.remove('is-hidden');
            if(elBattleMsg) elBattleMsg.classList.remove('is-hidden');
            pwaLogger("Deskripsi ditutup.");
        }
        
        function selectActionForTargeting(actionType, skillDetails) {
            const activeHero = getActiveHero();
            if (!activeHero) {
                pwaLogger("selectActionForTargeting: Tidak ada hero aktif!");
                return;
            }
            pwaLogger(`Aksi dipilih: ${actionType} - ${skillDetails.name || 'N/A'} oleh ${activeHero.Name}`);
            selectedAction = { 
                type: actionType, 
                id: skillDetails.id || (actionType === 'normalAttack' ? 'normalAttack' : null), 
                name: skillDetails.name, 
                spCost: skillDetails.spCost || 0, 
                targetType: skillDetails.targetType, // Diambil dari JSON
                range: skillDetails.range, // Diambil dari JSON
                desc: skillDetails.desc
            };
            pwaMode = "targeting";
            
            // Tampilkan deskripsi singkat skill yang dipilih
            const descTitle = selectedAction.name || actionType;
            let descContent = selectedAction.desc || "Pilih target.";
            if (selectedAction.spCost > 0) descContent += ` (Biaya: ${selectedAction.spCost} SP)`;
            showDescriptionPanel(descTitle, descContent);
            
            if(elBattleMsg) elBattleMsg.textContent = `Pilih target untuk ${selectedAction.name}...`;
            if(elCmdPanelActionButtons) elCmdPanelActionButtons.classList.add('is-hidden'); 
            refreshAllUIElements(); // Untuk me-render ulang PseudoMap dengan highlight target
        }

        function confirmTargetAndSendCommand(targetUnit) {
            const activeHero = getActiveHero();
            if (!activeHero) {
                pwaLogger("confirmTargetAndSendCommand: Tidak ada hero aktif untuk mengirim command!");
                pwaMode = "idle"; // Kembali ke idle jika error
                refreshAllUIElements();
                return;
            }

            pwaLogger(`Target dikonfirmasi: ${targetUnit.Name} (ID: ${targetUnit.id}) untuk aksi ${selectedAction.name} oleh ${activeHero.Name}`);
            hideDescriptionPanel(); 
            
            const targetItemInMap = elPseudomapStrip ? elPseudomapStrip.querySelector(`.pseudomap-unit-item[data-unit-id="${targetUnit.id}"]`) : null;
            if(targetItemInMap) targetItemInMap.classList.add('selected-in-map');

            if (window.AutoTools && typeof window.AutoTools.sendCommand === 'function') {
                const command = `actorId=${activeHero.id}&actionType=${selectedAction.type}&actionId=${selectedAction.id || selectedAction.name}&targetId=${targetUnit.id}`;
                window.AutoTools.sendCommand(command, "TBC_AKSI_PEMAIN", false);
                pwaLogger("Kirim command ke Tasker: " + command);
            } else { pwaLogger("AutoTools.sendCommand tidak tersedia."); }
            
            pwaMode = "idle"; // Kembali ke mode idle setelah mengirim command
            if(elBattleMsg) elBattleMsg.textContent = "Menunggu respon Tasker...";
            // UI akan diupdate penuh saat Tasker mengirim state baru
        }

        function refreshAllUIElements() {
            pwaLogger("Memulai refreshAllUIElements. Mode PWA: " + pwaMode);
            if (!bState || Object.keys(bState).length === 0) { 
                pwaLogger("refreshAllUIElements: bState kosong.");
                // Tampilkan state loading atau error yang lebih jelas
                if(elRoundTurn) elRoundTurn.textContent = "Ronde: - Turn: -";
                if(elBattleMsg && (!elDescPanelOverlay || !elDescPanelOverlay.classList.contains('visible'))) elBattleMsg.textContent = "Data battle tidak tersedia...";
                renderPseudomap(); // Tetap render pseudomap (akan menampilkan placeholder)
                if(elFocusedEnemyName) elFocusedEnemyName.textContent = "-";
                if(elFocusedEnemyHp) elFocusedEnemyHp.textContent = "HP: -/-";
                if(elCmdPanelActiveHeroInfo) elCmdPanelActiveHeroInfo.classList.add('is-hidden');
                if(elCmdPanelActionButtons) elCmdPanelActionButtons.classList.add('is-hidden');
                if(elTeamSpDisplay) elTeamSpDisplay.textContent = "SP Tim: -/-";
                return; 
            }
            
            if(elRoundTurn) elRoundTurn.textContent = `Ronde: ${bState.Round || '-'} Turn: ${bState.Turn || '-'}`;
            if(elBattleMsg && (!elDescPanelOverlay || !elDescPanelOverlay.classList.contains('visible'))) elBattleMsg.textContent = bState.BattleMessage || "Menunggu...";
            
            renderFocusedEnemy(); // Urutan bisa penting, enemy focus dulu
            renderPseudomap();    // Lalu pseudomap
            renderCommandPanel(); // Terakhir command panel

            pwaLogger("UI direfresh sepenuhnya. Mode PWA: " + pwaMode);
        }

        document.addEventListener('DOMContentLoaded', () => {
            elRoundTurn = document.getElementById('round-turn-info');
            elBattleMsg = document.getElementById('battle-message-area');
            elEnemyFocus = document.getElementById('enemy-focus-display');
            elFocusedEnemyName = document.getElementById('focused-enemy-name-text');
            elFocusedEnemyHp = document.getElementById('focused-enemy-hp-text');
            elPseudomapStrip = document.getElementById('pseudomap-strip');
            elCmdPanelActiveHeroInfo = document.getElementById('active-hero-display-info');
            if (elCmdPanelActiveHeroInfo) {
                elActiveHeroName = elCmdPanelActiveHeroInfo.querySelector('.name');
                elActiveHeroHp = elCmdPanelActiveHeroInfo.querySelector('.hp');
                elActiveHeroGauge = elCmdPanelActiveHeroInfo.querySelector('.gauge');
            } else { pwaLogger("ERROR: #active-hero-display-info tidak ditemukan!"); }
            
            elCmdPanelActionButtons = document.getElementById('action-buttons-list');
            elBtnAtk = document.getElementById('btn-normal-attack');
            elBtnSkill = document.getElementById('btn-unique-skill');
            elBtnUlt = document.getElementById('btn-ultimate-skill');
            elBtnCancelAction = document.getElementById('btn-cancel-action');
            elTeamSpDisplay = document.getElementById('team-sp-indicator');
            elDescPanelOverlay = document.getElementById('description-panel-overlay');
            elDescTitleText = document.getElementById('description-title-text');
            elDescContentArea = document.getElementById('description-panel-content-area');
            elCloseDescBtn = document.getElementById('close-description-button');
            elPwaLog = document.getElementById('pwaLogOutputArea');

            pwaLogger(`PWA TBC V5.2 Siap (DOM Loaded). MAX_VISIBLE_SLOTS: ${MAX_VISIBLE_SLOTS_PSEUDOMAP}`);

            try { 
                if (window.jsonDataBattle && typeof window.jsonDataBattle === 'string') {
                    bState = JSON.parse(window.jsonDataBattle); 
                    pwaLogger("Data awal JSON dari meta berhasil diparsing.");
                } else if (window.jsonDataBattle && typeof window.jsonDataBattle === 'object') {
                    bState = window.jsonDataBattle; 
                    pwaLogger("Data awal JSON dari meta adalah objek, digunakan langsung.");
                } else {
                    bState = {}; 
                    pwaLogger("Tidak ada jsonDataBattle di window, bState diinisialisasi kosong.");
                }
            } catch (e) { 
                pwaLogger("Error parsing JSON awal dari meta: " + e); 
                bState = { Units: [], BattleMessage: "Error data awal." }; 
            }
            
            if (window.infoGlobal && elBattleMsg && !bState.BattleMessage) {
                 elBattleMsg.textContent = window.infoGlobal;
            }
            
            refreshAllUIElements();

            if(elCmdPanelActiveHeroInfo) {
                elCmdPanelActiveHeroInfo.addEventListener('click', () => {
                    const activeHero = getActiveHero();
                    if (pwaMode === "idle" && activeHero && activeHero.Type === "Ally") { 
                        pwaMode = "player_action_pending";
                        pwaLogger("Panel Info Hero Aktif di-tap. Mode diubah ke: player_action_pending.");
                        refreshAllUIElements(); 
                    } else {
                        pwaLogger(`Tap di Panel Info Hero diabaikan. Mode: ${pwaMode}, Hero Aktif: ${activeHero ? activeHero.Name : 'Tidak ada'}, Tipe: ${activeHero ? activeHero.Type : 'N/A'}`);
                    }
                });
            }

            if(elBtnAtk) elBtnAtk.addEventListener('click', () => {
                const activeHero = getActiveHero();
                if (!activeHero || !activeHero.Skills) { pwaLogger("Attack gagal: Hero atau skills tidak ada."); return; }
                selectActionForTargeting('normalAttack', {
                    name: activeHero.Skills.normalAttackName || "Serang Biasa",
                    desc: activeHero.Skills.normalAttackDesc || "Serangan fisik standar.",
                    targetType: activeHero.Skills.targetType || "SingleEnemy", // Ambil dari JSON
                    range: activeHero.Skills.range || 1 // Ambil dari JSON
                });
            });
            if(elBtnSkill) elBtnSkill.addEventListener('click', () => {
                const activeHero = getActiveHero();
                if (!activeHero || !activeHero.Skills) { pwaLogger("Skill gagal: Hero atau skills tidak ada."); return; }
                const spCost = activeHero.Skills.uniqueSkillSpCost || 0;
                if (bState.TeamSP >= spCost ) {
                    selectActionForTargeting('uniqueSkill', {
                        id: activeHero.Skills.uniqueSkillId,
                        name: activeHero.Skills.uniqueSkillName || "Skill Unik",
                        spCost: spCost,
                        targetType: activeHero.Skills.targetType, // Ambil dari JSON
                        range: activeHero.Skills.range, // Ambil dari JSON
                        desc: activeHero.Skills.uniqueSkillDesc || "Efek skill unik."
                    });
                } else {
                    pwaLogger(`SP Tim tidak cukup untuk Skill! Butuh: ${spCost}, Punya: ${bState.TeamSP}`);
                    alert(`SP Tim tidak cukup! Butuh: ${spCost}, Punya: ${bState.TeamSP}`); 
                }
            });
            if(elBtnUlt) elBtnUlt.addEventListener('click', () => {
                 const activeHero = getActiveHero();
                 if (!activeHero || !activeHero.Skills) { pwaLogger("Ultimate gagal: Hero atau skills tidak ada."); return; }
                 if ((activeHero.CurrentGauge || 0) >= (activeHero.MaxGauge || 100)) {
                    selectActionForTargeting('ultimateSkill', {
                        id: activeHero.Skills.ultimateId, // Jika ada ID spesifik
                        name: activeHero.Skills.ultimateName || "Ultimate",
                        targetType: activeHero.Skills.targetType, // Ambil dari JSON
                        range: activeHero.Skills.range, // Ambil dari JSON
                        desc: activeHero.Skills.ultimateDesc || "Serangan pamungkas."
                    });
                 } else {
                    pwaLogger("Gauge Ultimate belum penuh!");
                    alert("Gauge Ultimate belum penuh!");
                 }
            });
            if(elBtnCancelAction) elBtnCancelAction.addEventListener('click', () => {
                pwaMode = "idle";
                hideDescriptionPanel();
                pwaLogger("Aksi dibatalkan oleh pemain. Mode diubah ke: idle.");
                refreshAllUIElements();
            });

            if(elCloseDescBtn) elCloseDescBtn.addEventListener('click', hideDescriptionPanel);
            
            if(elEnemyFocus) { /* ... (event listener swipe enemy focus tetap sama) ... */ }
        });

        var autoToolsUpdateValues = function(values) {
            pwaLogger("autoToolsUpdateValues dipanggil oleh Tasker.");
            // ... (sisa fungsi sama seperti v5.1) ...
            let logValues = {...values};
            if(logValues.jsonDataBattle && typeof logValues.jsonDataBattle === 'string') {
                logValues.jsonDataBattle = `(JSON diterima - panjang: ${values.jsonDataBattle.length})`;
            } else if (logValues.jsonDataBattle && typeof logValues.jsonDataBattle === 'object') {
                logValues.jsonDataBattle = `(Data objek diterima)`;
            }
            pwaLogger("Data dari Tasker: " + JSON.stringify(logValues));

            if (values.infoGlobal && elBattleMsg) {
                elBattleMsg.textContent = values.infoGlobal;
            }

            if (values.jsonDataBattle) {
                let newBState;
                try {
                    if (typeof values.jsonDataBattle === 'string') {
                        newBState = JSON.parse(values.jsonDataBattle);
                    } else if (typeof values.jsonDataBattle === 'object') {
                        newBState = values.jsonDataBattle; 
                    } else {
                        pwaLogger("Format jsonDataBattle dari Tasker tidak dikenal.");
                        return;
                    }

                    if (JSON.stringify(bState) !== JSON.stringify(newBState)) {
                        bState = newBState;
                        pwaMode = "idle"; 
                        hideDescriptionPanel(); 
                        refreshAllUIElements();
                        pwaLogger("State battle PWA berhasil diupdate dari Tasker.");
                    } else {
                        pwaLogger("Data JSON dari Tasker sama dengan state saat ini, tidak ada update UI besar.");
                        if (values.infoGlobal && elBattleMsg && elBattleMsg.textContent !== values.infoGlobal) {
                           elBattleMsg.textContent = values.infoGlobal;
                        }
                    }
                } catch (e) {
                    pwaLogger("Error parsing atau memproses jsonDataBattle dari update Tasker: " + e);
                }
            }
        };
        pwaLogger("Skrip PWA TBC V5.2 selesai dimuat.");
    </script>
</body>
</html>
