<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>TBC Konsep V5 (Teks)</title>

    <meta name="autotoolswebscreen" type="variablejs" id="jsonDataBattle" label="Data JSON Battle" defaultValue="{}" />
    <meta name="autotoolswebscreen" type="variablejs" id="infoGlobal" label="Info Global" defaultValue="Memuat..." />

    <style>
        :root {
            --bg-main: #282c34; --text-main: #abb2bf; --bg-panel: #21252b; --border-color: #3e4451;
            --accent-blue: #61afef; --accent-green: #98c379; --accent-red: #e06c75;
            --accent-yellow: #e5c07b; --accent-purple: #c678dd; --accent-orange: #ffb86c;
        }
        body { font-family: 'Verdana', sans-serif; margin: 0; background-color: var(--bg-main); color: var(--text-main); display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        button { font-family: inherit; }
        /* Area Atas */
        .top-info-bar { padding: 8px 12px; text-align: center; background-color: var(--bg-panel); border-bottom: 1px solid var(--border-color); }
        #round-turn-info { font-size: 0.9em; }
        #battle-message-area { padding: 8px 12px; text-align: center; min-height: 20px; font-style: italic; background-color: rgba(0,0,0,0.1); font-size: 0.85em;}
        /* Area Musuh Utama */
        #enemy-focus-display { padding: 15px; margin: 10px auto; width: calc(100% - 40px); max-width: 350px; background-color: var(--bg-panel); border-radius: 8px; text-align: center; border: 2px solid var(--border-color); transition: border-color 0.2s, box-shadow 0.2s; }
        #enemy-focus-display.targetable { cursor: pointer; border-color: var(--accent-orange); }
        #enemy-focus-display.selected-target { border-color: var(--accent-red); box-shadow: 0 0 10px var(--accent-red); }
        #focused-enemy-name-text { font-size: 1.1em; font-weight: bold; color: var(--accent-blue); margin-bottom: 5px; }
        #focused-enemy-hp-text { font-size: 0.9em; }
        /* PseudoMap */
        #pseudomap-container { width: 100%; background-color: var(--bg-panel); padding: 8px 0; overflow-x: auto; white-space: nowrap; text-align: center; border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); margin-top: auto; /* Mendorong ke tengah jika konten sedikit */ }
        .pseudomap-unit-item { display: inline-block; background-color: var(--bg-main); border: 1px solid var(--border-color); padding: 6px 10px; margin: 0 3px; border-radius: 4px; text-align: center; min-width: 75px; font-size: 0.75em; transition: transform 0.2s, border-color 0.2s; }
        .pseudomap-unit-item.active-turn-unit { border-color: var(--accent-green); transform: scale(1.05); font-weight: bold; }
        .pseudomap-unit-item.targetable-in-map { cursor: pointer; border-color: var(--accent-orange) !important; } /* !important untuk override .active-turn-unit jika perlu */
        .pseudomap-unit-item.selected-in-map { border-color: var(--accent-red) !important; box-shadow: 0 0 8px var(--accent-red); }
        .pseudomap-unit-item.ally-unit { border-left: 3px solid var(--accent-blue); }
        .pseudomap-unit-item.enemy-unit { border-left: 3px solid var(--accent-red); }
        .pseudomap-unit-item .unit-name-text { display: block; }
        .pseudomap-unit-item .unit-hp-text { font-size: 0.9em; color: var(--accent-yellow); }
        /* Panel Perintah Pertempuran (Bawah) */
        #battle-command-panel { background-color: var(--bg-panel); padding: 10px; border-top: 1px solid var(--border-color); width: 100%; box-sizing: border-box; text-align: center; position: fixed; bottom: 0; left: 0; }
        .active-hero-info { margin-bottom: 10px; }
        .active-hero-info .name { font-size: 1.2em; font-weight: bold; color: var(--accent-green); }
        .active-hero-info .hp { font-size: 0.9em; }
        .action-buttons button { background-color: var(--accent-purple); color: #f8f8f2; border: none; padding: 10px 15px; margin: 5px; font-size: 0.9em; border-radius: 5px; cursor: pointer; min-width: 80px; }
        .action-buttons button.ultimate-btn { background-color: var(--accent-yellow); color: var(--bg-main); }
        .action-buttons button:disabled { background-color: #555; color: #888; cursor: not-allowed; }
        #team-sp-display { margin-top: 8px; font-size: 0.9em; }
        /* Panel Deskripsi (awalnya tersembunyi) */
        #description-panel { position: fixed; bottom: 0; left: 0; width: 100%; background-color: rgba(30, 30, 40, 0.95); color: #f0f0f0; padding: 15px; box-sizing: border-box; z-index: 100; border-top: 2px solid var(--accent-yellow); transition: transform 0.3s ease-out; transform: translateY(100%); /* Mulai dari bawah layar */ }
        #description-panel.visible { transform: translateY(0); }
        #description-panel h3 { margin-top: 0; color: var(--accent-yellow); }
        #description-panel-content { font-size: 0.85em; max-height: 100px; overflow-y: auto; }
        #close-description-btn { display: block; margin: 10px auto 0 auto; padding: 8px 15px; background-color: var(--accent-red); color:white; border:none; border-radius:4px; }

        .is-hidden { display: none !important; }
        .pwa-log-area { position: fixed; bottom: 0; right:0; width: 40%; background-color: rgba(0,0,0,0.7); color: #0f0; font-size:0.5em; max-height: 60px; overflow-y:auto; padding: 2px; box-sizing: border-box; z-index: 1001; opacity: 0.7; }
        .pwa-log-area pre { margin:0; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div class="top-info-bar">
        <span id="round-turn-info">Ronde: - Turn: -</span>
    </div>
    <div id="battle-message-area">Memuat pesan...</div>

    <div class="game-main-content">
        <div id="enemy-focus-display">
            <div id="focused-enemy-name-text">Musuh</div>
            <div id="focused-enemy-hp-text">HP: -/-</div>
        </div>
    </div>

    <div id="pseudomap-container">
        <div id="pseudomap-strip">
            </div>
    </div>

    <div id="battle-command-panel">
        <div id="active-hero-display-info" class="is-hidden">
            <span class="name">Nama Hero Aktif</span> (<span class="hp">HP: -/-</span>)<br>
            <span class="gauge">Gauge: -%</span>
        </div>
        <div id="action-buttons-list" class="is-hidden">
            <button id="btn-normal-attack">Attack</button>
            <button id="btn-unique-skill">Skill</button>
            <button id="btn-ultimate-skill" class="ultimate-btn">Ultimate</button>
            <button id="btn-cancel-action" style="background-color: #777;">Batal</button>
        </div>
        <div id="team-sp-display">SP Tim: -/-</div>
    </div>

    <div id="description-panel">
        <h3 id="description-title">Deskripsi</h3>
        <div id="description-panel-content">Konten deskripsi akan muncul di sini...</div>
        <button id="close-description-btn">Tutup</button>
    </div>

    <div class="pwa-log-area">
        <strong>Log PWA:</strong>
        <pre id="pwaLogOutputArea"></pre>
    </div>

    <script type="text/javascript">
        // --- State PWA ---
        let bState = {}; // Battle State dari Tasker
        let pwaMode = "idle"; // "idle", "hero_selected_for_action", "targeting"
        let selectedAction = { type: null, id: null, name: null, spCost: 0, targetType: null };
        let focusedEnemyIdxPWA = 0;
        let activeHeroPWA = null;

        // --- Referensi Elemen DOM ---
        let elRoundTurn, elBattleMsg, elEnemyFocus, elEnemyName, elEnemyHp;
        let elPseudomapStrip, elCmdPanel, elActiveHeroInfo, elActiveHeroName, elActiveHeroHp, elActiveHeroGauge;
        let elActionButtons, elBtnAtk, elBtnSkill, elBtnUlt, elBtnCancelAction;
        let elTeamSp, elDescPanel, elDescTitle, elDescContent, elCloseDescBtn, elLog;

        function log(msg) { /* Implementasi log seperti sebelumnya */ if(elLog) {elLog.textContent += `[${new Date().toLocaleTimeString().split(" ")[0]}] ${msg}\n`; elLog.scrollTop = elLog.scrollHeight;} console.log(msg); }

        // --- Fungsi Update UI ---
        function renderFocusedEnemy() {
            if (!bState.Units) return;
            const livingEnemies = bState.Units.filter(u => u.Type === "Enemy" && u.Stats.HP > 0);
            if (livingEnemies.length === 0) {
                elFocusedEnemyName.textContent = "Musuh Habis!"; elFocusedEnemyHp.textContent = ""; return;
            }
            focusedEnemyInDisplayIndex = Math.max(0, Math.min(focusedEnemyInDisplayIndex, livingEnemies.length - 1));
            const enemy = livingEnemies[focusedEnemyInDisplayIndex];
            if (enemy) {
                elFocusedEnemyName.textContent = enemy.Name;
                elFocusedEnemyHp.textContent = `HP: ${enemy.Stats.HP}/${enemy.Stats.MaxHP}`;
            }
        }

        function renderPseudomap() {
            elPseudomapStrip.innerHTML = "";
            if (!bState.Units) return;
            bState.Units.forEach(unit => { // Asumsi Tasker sudah urutkan by PseudoPos
                const item = document.createElement('div');
                item.classList.add('pseudomap-unit-item', unit.Type === "Ally" ? 'ally-unit' : 'enemy-unit');
                item.dataset.unitId = unit.id;
                item.innerHTML = `<span class="unit-name-map">${unit.Name}</span><span class="unit-hp-map">HP: ${unit.Stats.HP}</span>`;

                if (unit.id === bState.ActiveUnitID) item.classList.add('current-turn-unit');
                
                if (pwaMode === "targeting" && unit.Stats.HP > 0) {
                    // Logika validasi target (sederhana untuk sekarang: semua musuh untuk attack/skill ofensif, semua ally untuk skill support)
                    let isValidTarget = false;
                    if (selectedAction.targetType === "MusuhTunggal" && unit.Type === "Enemy") isValidTarget = true;
                    if (selectedAction.targetType === "AllyTunggal" && unit.Type === "Ally") isValidTarget = true;
                    // Nanti bisa lebih kompleks: if (selectedAction.targetType === "DiriSendiri" && unit.id === activeHeroPWA.id) isValidTarget = true;
                    
                    if (isValidTarget) {
                        item.classList.add('targetable-in-map');
                        item.onclick = () => handleTargetSelectionInMap(unit);
                    } else {
                        item.style.opacity = "0.5"; item.style.filter = "grayscale(80%)";
                    }
                }
                elPseudomapStrip.appendChild(item);
            });
        }
        
        function renderCommandPanel() {
            activeHeroPWA = bState.Units && bState.Units.find(u => u.id === bState.ActiveUnitID && u.Type === "Ally");
            if (activeHeroPWA && bState.BattleState === "Ongoing" && pwaMode !== "targeting") {
                elActiveHeroInfo.classList.remove('is-hidden');
                elActionButtons.classList.add('is-hidden'); // Sembunyikan tombol dulu
                elActiveHeroName.textContent = activeHeroPWA.Name;
                elActiveHeroHp.textContent = `HP: ${activeHeroPWA.Stats.HP}/${activeHeroPWA.Stats.MaxHP}`;
                elActiveHeroGauge.textContent = `Gauge: ${activeHeroPWA.CurrentGauge || 0}%`;
                
                // Event listener untuk tap hero di panel bawah untuk memunculkan aksi
                elActiveHeroInfo.onclick = () => {
                    if (pwaMode === "idle" && activeHeroPWA && activeHeroPWA.id === bState.ActiveUnitID) {
                        pwaMode = "player_action_pending";
                        elActiveHeroInfo.classList.add('is-hidden');
                        elActionButtons.classList.remove('is-hidden');
                        // Setup tombol aksi berdasarkan hero aktif
                        if(elBtnSkill && activeHeroPWA.Skills) elBtnSkill.textContent = activeHeroPWA.Skills.uniqueSkillName || "Skill";
                        if(elBtnUlt && activeHeroPWA.Skills) elBtnUlt.textContent = activeHeroPWA.Skills.ultimateName || "Ultimate";
                        if(elBtnUlt) elBtnUlt.disabled = (activeHeroPWA.CurrentGauge || 0) < 100;
                        log("Panel Aksi Ditampilkan untuk " + activeHeroPWA.Name);
                    }
                };

            } else {
                elActiveHeroInfo.classList.add('is-hidden');
                elActionButtons.classList.add('is-hidden');
            }
             if(elTeamSp) elTeamSp.textContent = `SP Tim: ${bState.TeamSP || 0}/${bState.MaxTeamSP || 5}`;
        }

        function showDescription(title, content) {
            elDescTitle.textContent = title;
            elDescContent.textContent = content;
            elDescPanel.classList.add('visible');
            // Sembunyikan SP & Battle Message, geser PseudoMap (implementasi animasi nanti)
            if(elTeamSp) elTeamSp.classList.add('is-hidden');
            if(elBattleMsg) elBattleMsg.classList.add('is-hidden');
            log(`Deskripsi ditampilkan: ${title}`);
        }
        function hideDescription() {
            elDescPanel.classList.remove('visible');
            if(elTeamSp) elTeamSp.classList.remove('is-hidden');
            if(elBattleMsg) elBattleMsg.classList.remove('is-hidden');
            log("Deskripsi ditutup.");
        }
        
        function handleActionSelection(actionType, skillId = null, skillName = null, spCost = 0, targetType = "MusuhTunggal", desc = "") {
            log(`Aksi dipilih: ${actionType} - ${skillName || 'N/A'}`);
            selectedAction = { type: actionType, id: skillId, name: skillName, spCost: spCost, targetType: targetType };
            pwaMode = "targeting";
            
            // Tampilkan deskripsi singkat aksi/skill menggantikan SP & Battle Message
            showDescription(skillName || actionType, desc + (spCost > 0 ? ` (Biaya: ${spCost} SP)`: ""));
            
            elBattleStatus.textContent = `Pilih target di Peta untuk ${skillName || actionType}...`;
            elActionButtons.classList.add('is-hidden'); // Sembunyikan tombol aksi setelah dipilih
            refreshAllUIElements(); // Untuk update PseudoMap dengan highlight targetable
        }

        function handleTargetSelectionInMap(targetUnit) {
            log(`Target dipilih di Peta: ${targetUnit.Name} (ID: ${targetUnit.id}) untuk aksi ${selectedAction.type}`);
            hideDescription(); // Tutup panel deskripsi
            
            const targetItemInMap = elPseudomapStrip.querySelector(`.pseudomap-unit-item[data-unit-id="${targetUnit.id}"]`);
            if(targetItemInMap) targetItemInMap.classList.add('selected-in-map');

            if (window.AutoTools && typeof window.AutoTools.sendCommand === 'function') {
                const command = `actorId=${activeHeroPWA.id}&actionType=${selectedAction.type}&actionId=${selectedAction.id || 'normalAttack'}&targetId=${targetUnit.id}`;
                window.AutoTools.sendCommand(command, "TBC_AKSI_PEMAIN", false);
                log("Kirim command ke Tasker: " + command);
            } else { log("AutoTools.sendCommand tidak tersedia."); }
            
            pwaMode = "idle";
            elBattleStatus.textContent = "Aksi dikirim ke Tasker...";
            // UI akan diupdate penuh saat Tasker mengirim state baru
        }

        function refreshAllUIElements() {
            if (!bState.Units) { log("refreshAllUIElements: bState.Units kosong."); return; }
            activeHeroPWA = bState.Units.find(u => u.id === bState.ActiveUnitID);
            
            if(elRoundTurn) elRoundTurn.textContent = `Ronde: ${bState.Round || '-'} Turn: ${bState.Turn || '-'}`;
            if(elBattleMsg && !elDescPanel.classList.contains('visible')) elBattleMsg.textContent = bState.BattleMessage || "Menunggu...";
            
            renderPseudomap();
            renderFocusedEnemyOnUI();
            renderCommandPanel();

            log("UI direfresh. Mode PWA: " + pwaMode);
        }

        // --- Inisialisasi ---
        document.addEventListener('DOMContentLoaded', () => {
            elRoundTurn = document.getElementById('round-turn-info');
            elBattleMsg = document.getElementById('battle-message-area');
            elEnemyFocusBox = document.getElementById('enemy-focus-display');
            elFocusedEnemyName = document.getElementById('focused-enemy-name-text');
            elFocusedEnemyHp = document.getElementById('focused-enemy-hp-text');
            elPseudomapStrip = document.getElementById('pseudomap-strip');
            elCmdPanel = document.getElementById('battle-command-panel');
            elActiveHeroInfo = document.getElementById('active-hero-display-info');
            elActiveHeroName = elActiveHeroInfo.querySelector('.name');
            elActiveHeroHp = elActiveHeroInfo.querySelector('.hp');
            elActiveHeroGauge = elActiveHeroInfo.querySelector('.gauge');
            elActionButtons = document.getElementById('action-buttons-list');
            elBtnAtk = document.getElementById('btn-normal-attack');
            elBtnSkill = document.getElementById('btn-unique-skill');
            elBtnUlt = document.getElementById('btn-ultimate-skill');
            elBtnCancelAction = document.getElementById('btn-cancel-action');
            elTeamSp = document.getElementById('team-sp-display');
            elDescPanel = document.getElementById('description-panel');
            elDescTitle = document.getElementById('description-title');
            elDescContent = document.getElementById('description-panel-content');
            elCloseDescBtn = document.getElementById('close-description-btn');
            elLog = document.getElementById('pwaLogOutputArea');

            log("PWA TBC V5 Konsep Siap.");

            try { bState = JSON.parse(window.jsonDataBattle || "{}"); } catch (e) { log("Error JSON awal: " + e); bState = {}; }
            if(window.infoGlobal && elBattleStatus) elBattleStatus.textContent = window.infoGlobal;
            
            refreshAllUIElements();

            // Event Listeners untuk Tombol Aksi
            elBtnAtk.addEventListener('click', () => {
                handleActionSelection('normalAttack', null, activeHeroPWA.Skills.normalAttackName || "Serang Biasa", 0, "MusuhTunggal", activeHeroPWA.Skills.normalAttackDesc);
            });
            elBtnSkill.addEventListener('click', () => {
                if (activeHeroPWA.Skills && (bState.TeamSP >= activeHeroPWA.Skills.uniqueSkillSpCost)) {
                    handleActionSelection('uniqueSkill', activeHeroPWA.Skills.uniqueSkillId, activeHeroPWA.Skills.uniqueSkillName, activeHeroPWA.Skills.uniqueSkillSpCost, activeHeroPWA.Skills.uniqueSkillTargetType || "MusuhTunggal", activeHeroPWA.Skills.uniqueSkillDesc);
                } else {
                    log("SP Tidak cukup untuk Skill!");
                    alert("SP Tim tidak cukup!"); // Feedback sederhana
                }
            });
            elBtnUlt.addEventListener('click', () => {
                 if (activeHeroPWA.CurrentGauge >= 100) {
                    handleActionSelection('ultimateSkill', null, activeHeroPWA.Skills.ultimateName, 0, activeHeroPWA.Skills.ultimateTargetType || "MusuhTunggal", activeHeroPWA.Skills.ultimateDesc);
                 } else {
                    log("Gauge Ultimate belum penuh!");
                    alert("Gauge Ultimate belum penuh!");
                 }
            });
            elBtnCancelAction.addEventListener('click', () => {
                pwaMode = "idle";
                hideDescription();
                elActiveHeroInfo.classList.remove('is-hidden');
                elActionButtons.classList.add('is-hidden');
                refreshAllUIElements();
                log("Aksi dibatalkan.");
            });

            // Event Listener untuk menutup panel deskripsi
            elCloseDescBtn.addEventListener('click', hideDescription);
            // Tap di luar panel deskripsi untuk menutup (implementasi lebih lanjut jika panel deskripsi adalah modal)
            // elDescPanel.addEventListener('click', (e) => { if(e.target === elDescPanel) hideDescription(); });


            // Tap Musuh di Area Fokus (untuk info detail)
            elEnemyFocusBox.addEventListener('click', () => {
                if (pwaMode === "idle" && bState.Units) {
                    const livingEnemies = bState.Units.filter(u => u.Type === "Enemy" && u.Stats.HP > 0);
                    if (livingEnemies.length > 0 && focusedEnemyInDisplayIndex < livingEnemies.length) {
                        const enemy = livingEnemies[focusedEnemyInDisplayIndex];
                        showDescription(`Info: ${enemy.Name}`, `HP: ${enemy.Stats.HP}/${enemy.Stats.MaxHP}\nATK: ${enemy.Stats.ATK}\n(Buff/Debuff akan muncul di sini)`);
                    }
                }
            });

            // Swipe untuk ganti fokus musuh
            let enemySwipeStartX = 0;
            elEnemyFocusBox.addEventListener('touchstart', (e) => { enemySwipeStartX = e.touches[0].clientX; }, { passive: true });
            elEnemyFocusBox.addEventListener('touchend', (e) => {
                if (pwaMode !== "idle") return; 
                let enemySwipeEndX = e.changedTouches[0].clientX;
                const livingEnemies = bState.Units ? bState.Units.filter(u => u.Type === "Enemy" && u.Stats.HP > 0) : [];
                if (Math.abs(enemySwipeStartX - enemySwipeEndX) > 30 && livingEnemies.length > 1) {
                    if (enemySwipeEndX < enemySwipeStartX) { 
                        focusedEnemyInDisplayIndex = (focusedEnemyInDisplayIndex + 1) % livingEnemies.length;
                    } else { 
                        focusedEnemyInDisplayIndex = (focusedEnemyInDisplayIndex - 1 + livingEnemies.length) % livingEnemies.length;
                    }
                    renderFocusedEnemyOnUI(); 
                    log(`Musuh difokuskan: ${livingEnemies[focusedEnemyInDisplayIndex].Name}`);
                }
            }, { passive: true });

        });

        // Fungsi yang dipanggil Tasker untuk update PWA
        var autoToolsUpdateValues = function(values) {
            log("autoToolsUpdateValues dipanggil.");
            let logValues = {...values};
            if(logValues.jsonDataBattle) logValues.jsonDataBattle = `(JSON diterima - panjang: ${values.jsonDataBattle.length})`;
            log("Data dari Tasker: " + JSON.stringify(logValues));

            if (values.infoGlobal) {
                if(elBattleStatus) elBattleStatus.textContent = values.infoGlobal;
            }

            if (values.jsonDataBattle) {
                try {
                    bState = JSON.parse(values.jsonDataBattle);
                    pwaMode = "idle"; // Reset mode setelah update state dari Tasker
                    hideDescription(); // Pastikan panel deskripsi tertutup saat state baru masuk
                    refreshAllUIElements();
                    log("State battle PWA berhasil diupdate dari Tasker.");
                } catch (e) {
                    log("Error parsing jsonDataBattle dari update Tasker: " + e);
                }
            }
        };
        log("Skrip PWA TBC V5 Konsep selesai.");
    </script>
</body>
</html>
