<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>TBC Teks Sederhana</title>

    <meta name="autotoolswebscreen" type="variablejs" id="jsonDataBattle" label="Data JSON Battle" defaultValue="{}" />
    <meta name="autotoolswebscreen" type="variablejs" id="infoGlobal" label="Info Global" defaultValue="Memuat pertarungan..." />

    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            background-color: #2c3e50; /* Latar gelap */
            color: #ecf0f1; /* Teks terang */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            height: 100vh;
            overflow: hidden;
            padding: 5px 0;
            box-sizing: border-box;
        }
        .game-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-grow: 1;
            justify-content: center;
        }
        #enemy-display {
            background-color: rgba(0,0,0,0.15);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            width: 85%;
            max-width: 320px;
            text-align: center;
            min-height: 80px;
            border: 2px solid transparent;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        #enemy-display.targetable {
            cursor: pointer;
            border-color: #e67e22; /* Oranye saat bisa ditarget */
        }
        #enemy-display.target-selected {
            border-color: #c0392b; /* Merah tua saat terpilih */
            box-shadow: 0 0 10px #c0392b;
        }
        #enemy-name-display { font-size: 1.1em; font-weight: bold; margin-bottom: 5px; }
        #enemy-hp-display { font-size: 0.9em; }

        #action-button-container {
            margin-bottom: 10px;
            height: 45px; /* Ruang untuk tombol */
        }
        #btn-attack {
            background-color: #c0392b; /* Merah */
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 1em;
            border-radius: 5px;
            cursor: pointer;
        }
        .hidden { display: none !important; }

        #pseudo-map {
            width: 100%;
            background-color: rgba(0,0,0,0.25);
            padding: 8px 0;
            overflow-x: auto;
            white-space: nowrap;
            text-align: center; /* Pusatkan item jika tidak overflow */
        }
        .unit-item {
            display: inline-block;
            background-color: #34495e;
            padding: 6px 10px;
            margin: 0 4px;
            border-radius: 4px;
            text-align: center;
            min-width: 80px;
            border: 2px solid transparent;
            font-size: 0.8em;
        }
        .unit-item.active {
            border-color: #2980b9; /* Biru */
            transform: scale(1.05);
        }
        .unit-item.player-action {
            cursor: pointer;
            border-color: #27ae60; /* Hijau */
        }
        .unit-item .name { display: block; font-weight: bold; }
        .unit-item .hp { font-size: 0.85em; color: #bdc3c7; }

        #global-info { text-align: center; padding: 5px; font-size: 0.85em; color: #bdc3c7; height: 18px;}
        .log-output { position: fixed; bottom: 0; left:0; width:100%; background-color: rgba(0,0,0,0.6); color: #8f8; font-size:0.55em; max-height: 50px; overflow-y:auto; padding: 3px; box-sizing: border-box; z-index: 100; }
        .log-output pre { margin:0; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="global-info">Memuat...</div>

    <div class="game-container">
        <div id="enemy-display">
            <div id="enemy-name-display">Musuh</div>
            <div id="enemy-hp-display">HP: -/-</div>
        </div>
        <div id="action-button-container" class="hidden">
            <button id="btn-attack">Serang</button>
        </div>
    </div>

    <div id="pseudo-map">
        </div>

    <div class="log-output">
        <strong>Log PWA:</strong>
        <pre id="pwaLogArea"></pre>
    </div>

    <script type="text/javascript">
        let battleData = {};
        let currentActiveUnitId = null;
        let currentPwaMode = "idle"; // "idle", "action_pending", "targeting"
        let currentFocusedEnemyIdx = 0;

        // DOM Elements
        let elGlobalInfo, elEnemyDisplay, elEnemyName, elEnemyHp;
        let elActionBtnContainer, elBtnAttack, elPseudoMap, elPwaLog;

        function logToPwa(message) {
            if (elPwaLog) {
                const time = new Date().toLocaleTimeString('id-ID', { hour12: false });
                elPwaLog.textContent += `[${time}] ${message}\n`;
                elPwaLog.scrollTop = elPwaLog.scrollHeight;
            }
            console.log(`[PWA_TBC_TEXT] ${message}`);
        }

        function displayFocusedEnemy() {
            if (!battleData.Units || battleData.Units.length === 0) return;
            const enemies = battleData.Units.filter(u => u.Type === "Enemy" && u.Stats.HP > 0);
            if (enemies.length === 0) {
                elEnemyName.textContent = "Musuh Dikalahkan!";
                elEnemyHp.textContent = "";
                return;
            }
            currentFocusedEnemyIdx = Math.max(0, Math.min(currentFocusedEnemyIdx, enemies.length - 1));
            const enemy = enemies[currentFocusedEnemyIdx];
            if (enemy) {
                elEnemyName.textContent = enemy.Name;
                elEnemyHp.textContent = `HP: ${enemy.Stats.HP}/${enemy.Stats.MaxHP}`;
            }
        }

        function populatePseudoMap() {
            elPseudoMap.innerHTML = "";
            if (!battleData.Units) return;

            battleData.Units.forEach(unit => { // Asumsi sudah diurutkan Tasker
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('unit-item');
                itemDiv.dataset.unitId = unit.id || unit.Name; // Gunakan ID jika ada, fallback ke Nama

                const nameSpan = document.createElement('span');
                nameSpan.classList.add('name');
                nameSpan.textContent = unit.Name;
                itemDiv.appendChild(nameSpan);

                const hpSpan = document.createElement('span');
                hpSpan.classList.add('hp');
                hpSpan.textContent = `HP: ${unit.Stats.HP}/${unit.Stats.MaxHP}`;
                itemDiv.appendChild(hpSpan);

                if (unit.id === currentActiveUnitId || unit.Name === currentActiveUnitId) { // Cocokkan dengan ID atau Nama
                    itemDiv.classList.add('active');
                    if (unit.Type === "Ally") {
                        itemDiv.classList.add('player-action');
                        itemDiv.onclick = () => {
                            logToPwa(`Unit pemain ${unit.Name} di-tap.`);
                            currentPwaMode = "action_pending";
                            elActionBtnContainer.classList.remove('hidden');
                            itemDiv.classList.remove('player-action'); // Nonaktifkan klik lagi setelah tombol muncul
                        };
                    }
                }
                elPseudoMap.appendChild(itemDiv);
            });
        }

        function refreshFullUI() {
            if (!battleData) return;
            currentActiveUnitId = battleData.ActiveUnitID || (battleData.Units && battleData.Units.find(u => u.Status === "Active")?.id) || (battleData.Units && battleData.Units.find(u => u.Status === "Active")?.Name);

            populatePseudoMap();
            displayFocusedEnemy();
            elGlobalInfo.textContent = battleData.BattleMessage || "Giliran berlangsung...";

            if (currentPwaMode === "action_pending") {
                // Tombol sudah visible
            } else {
                elActionBtnContainer.classList.add('hidden');
            }
            
            elEnemyDisplay.classList.toggle('targetable', currentPwaMode === "targeting");
            if(currentPwaMode !== "targeting") elEnemyDisplay.classList.remove('target-selected');
        }

        document.addEventListener('DOMContentLoaded', () => {
            elGlobalInfo = document.getElementById('global-info');
            elEnemyDisplay = document.getElementById('enemy-display');
            elEnemyName = document.getElementById('enemy-name-display');
            elEnemyHp = document.getElementById('enemy-hp-display');
            elActionBtnContainer = document.getElementById('action-button-container');
            elBtnAttack = document.getElementById('btn-attack');
            elPseudoMap = document.getElementById('pseudo-map');
            elPwaLog = document.getElementById('pwaLogArea');

            logToPwa("PWA Teks Sederhana Siap.");

            try {
                battleData = JSON.parse(window.jsonDataBattle || "{}");
                logToPwa("Data awal dari meta: " + (window.jsonDataBattle ? "Ada" : "Kosong"));
            } catch (e) {
                logToPwa("Error parse JSON awal: " + e);
                battleData = { Units: [], BattleMessage: "Error data awal." };
            }
            if(window.infoGlobal) elGlobalInfo.textContent = window.infoGlobal;
            
            refreshFullUI();

            elBtnAttack.addEventListener('click', () => {
                logToPwa("Tombol Serang diklik.");
                currentPwaMode = "targeting";
                elGlobalInfo.textContent = "Pilih target musuh...";
                elActionBtnContainer.classList.add('hidden');
                refreshFullUI(); // Untuk update kelas targetable
            });

            elEnemyDisplay.addEventListener('click', () => {
                if (currentPwaMode === "targeting") {
                    const enemies = battleData.Units.filter(u => u.Type === "Enemy" && u.Stats.HP > 0);
                    if (enemies.length > 0 && currentFocusedEnemyIdx < enemies.length) {
                        const targetEnemy = enemies[currentFocusedEnemyIdx];
                        const actor = battleData.Units.find(u => u.id === currentActiveUnitId || u.Name === currentActiveUnitId);
                        
                        if (!actor) {
                            logToPwa("Error: Tidak bisa menemukan unit aktif untuk menyerang.");
                            currentPwaMode = "idle";
                            refreshFullUI();
                            return;
                        }

                        logToPwa(`${actor.Name} menargetkan ${targetEnemy.Name}.`);
                        elEnemyDisplay.classList.add('target-selected');

                        if (window.AutoTools && typeof window.AutoTools.sendCommand === 'function') {
                            const command = `actorId=${actor.id || actor.Name}&action=normalAttack&targetId=${targetEnemy.id || targetEnemy.Name}`;
                            window.AutoTools.sendCommand(command, "TBC_AKSI_PEMAIN", false);
                            logToPwa("Kirim command: " + command);
                        } else {
                            logToPwa("AutoTools.sendCommand tidak tersedia.");
                        }
                        currentPwaMode = "idle";
                        elGlobalInfo.textContent = "Aksi dikirim...";
                    }
                }
            });
            
            // Swipe sederhana untuk enemy display (ganti index fokus)
            let enemyTouchStartX = 0;
            elEnemyDisplay.addEventListener('touchstart', (e) => { enemyTouchStartX = e.touches[0].clientX; }, { passive: true });
            elEnemyDisplay.addEventListener('touchend', (e) => {
                if (currentPwaMode === "targeting") return; // Jangan swipe jika sedang memilih target spesifik
                let enemyTouchEndX = e.changedTouches[0].clientX;
                const enemies = battleData.Units ? battleData.Units.filter(u => u.Type === "Enemy" && u.Stats.HP > 0) : [];
                if (Math.abs(enemyTouchStartX - enemyTouchEndX) > 30 && enemies.length > 1) { // Threshold swipe
                    if (enemyTouchEndX < enemyTouchStartX) { // Swipe kiri (next)
                        currentFocusedEnemyIdx = (currentFocusedEnemyIdx + 1) % enemies.length;
                    } else { // Swipe kanan (prev)
                        currentFocusedEnemyIdx = (currentFocusedEnemyIdx - 1 + enemies.length) % enemies.length;
                    }
                    displayFocusedEnemy(); // Hanya update display musuh, bukan seluruh UI
                    logToPwa(`Musuh difokuskan ke index: ${currentFocusedEnemyIdx} (${enemies[currentFocusedEnemyIdx].Name})`);
                }
            }, { passive: true });

        });

        var autoToolsUpdateValues = function(values) {
            logToPwa("autoToolsUpdateValues dipanggil.");
            let logValues = {...values};
            if(logValues.jsonDataBattle) logValues.jsonDataBattle = `(JSON diterima - panjang: ${values.jsonDataBattle.length})`;
            logToPwa("Data: " + JSON.stringify(logValues));

            if (values.infoGlobal) {
                elGlobalInfo.textContent = values.infoGlobal;
            }

            if (values.jsonDataBattle) {
                try {
                    battleData = JSON.parse(values.jsonDataBattle);
                    currentPwaMode = "idle"; // Reset mode setelah update state dari Tasker
                    refreshFullUI();
                    logToPwa("State battle diupdate dari Tasker.");
                } catch (e) {
                    logToPwa("Error parsing jsonDataBattle update: " + e);
                }
            }
        };
        logToPwa("Skrip PWA Teks Sederhana selesai.");
    </script>
</body>
</html>
