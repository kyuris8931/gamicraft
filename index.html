<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inline Turn-Based Battle Test</title>

    <meta name="autotoolswebscreen" type="variablejs" id="hpPemain" label="HP Pemain" description="HP Pemain Saat Ini" defaultValue="100" subtype="number" />
    <meta name="autotoolswebscreen" type="variablejs" id="hpMusuh" label="HP Musuh" description="HP Musuh Saat Ini" defaultValue="80" subtype="number" />
    <meta name="autotoolswebscreen" type="variablejs" id="pesanStatus" label="Pesan Status" description="Pesan status pertarungan" defaultValue="Pertarungan dimulai!" />
    <meta name="autotoolswebscreen" type="variablejs" id="giliran" label="Giliran" description="Siapa yang giliran (pemain/musuh)" defaultValue="pemain" />

    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 15px; background-color: #2c3e50; color: #ecf0f1; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        #battleBox { background-color: #34495e; padding: 20px; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.5); text-align: center; width: 90%; max-width: 400px; }
        .unit { margin-bottom: 15px; padding: 10px; background-color: #4a627a; border-radius: 5px; }
        .unit h3 { margin-top: 0; color: #e67e22; }
        .hp-bar-container { background-color: #2c3e50; border-radius: 5px; padding: 3px; margin-top: 5px; }
        .hp-bar { background-color: #2ecc71; height: 20px; border-radius: 3px; width: 100%; transition: width 0.3s ease-in-out; }
        .enemy .hp-bar { background-color: #e74c3c; } /* Merah untuk musuh */
        button { background-color: #3498db; color: white; border: none; padding: 10px 15px; font-size: 1em; border-radius: 5px; cursor: pointer; margin-top: 10px; transition: background-color 0.2s; }
        button:hover { background-color: #2980b9; }
        button:disabled { background-color: #7f8c8d; cursor: not-allowed; }
        #statusArea { margin-top: 15px; font-style: italic; color: #bdc3c7; min-height: 20px; }
        .log-area { font-size:0.7em; color: #95a5a6; max-height:100px; overflow-y:auto; border-top:1px solid #4a627a; padding-top:8px; margin-top: 15px; text-align: left;}
        .log-area pre { margin: 0; white-space: pre-wrap; word-break: break-all; }
    </style>
</head>
<body>
    <div id="battleBox">
        <h2>Turn-Based Battle</h2>

        <div class="unit player">
            <h3>Pemain</h3>
            <p>HP: <span id="hpPemainVal">100</span> / <span id="hpPemainMax">100</span></p>
            <div class="hp-bar-container"><div class="hp-bar" id="hpPemainBar"></div></div>
        </div>

        <div class="unit enemy">
            <h3>Musuh</h3>
            <p>HP: <span id="hpMusuhVal">80</span> / <span id="hpMusuhMax">80</span></p>
            <div class="hp-bar-container"><div class="hp-bar" id="hpMusuhBar"></div></div>
        </div>

        <button id="tombolSerang" onclick="serangMusuh()">Serang Musuh!</button>
        <div id="statusArea">Pertarungan dimulai!</div>

        <div class="log-area">
            <strong>Log PWA:</strong><br>
            <pre id="logOutput"></pre>
        </div>
    </div>

    <script type="text/javascript">
        // Variabel global untuk menyimpan Max HP (diambil dari nilai awal)
        let pemainMaxHP, musuhMaxHP;
        let hpPemainSekarang, hpMusuhSekarang;
        let giliranSekarang;

        // Fungsi log sederhana
        function logPesan(pesan) {
            const logEl = document.getElementById('logOutput');
            if (logEl) {
                const waktu = new Date().toLocaleTimeString('id-ID', { hour12: false });
                logEl.textContent += `[${waktu}] ${pesan}\n`;
                logEl.scrollTop = logEl.scrollHeight;
            }
            console.log(`[InlineBattle - ${new Date().toLocaleTimeString('id-ID', { hour12: false })}] ${pesan}`);
        }

        function updateTampilanHP(unit, hpSekarang, hpMax) {
            const valEl = document.getElementById(`hp${unit}Val`);
            const barEl = document.getElementById(`hp${unit}Bar`);
            const maxEl = document.getElementById(`hp${unit}Max`);

            if (valEl) valEl.textContent = hpSekarang;
            if (maxEl) maxEl.textContent = hpMax; // Update Max HP jika berubah
            if (barEl) {
                const persen = hpMax > 0 ? (hpSekarang / hpMax) * 100 : 0;
                barEl.style.width = `${Math.max(0, persen)}%`;
            }
        }

        function updateStatus(pesan) {
            const statusEl = document.getElementById('statusArea');
            if (statusEl) statusEl.textContent = pesan;
            logPesan(`Status: ${pesan}`);
        }

        function updateTombolSerang() {
            const tombol = document.getElementById('tombolSerang');
            if (tombol) {
                tombol.disabled = (giliranSekarang !== 'pemain' || hpPemainSekarang <= 0 || hpMusuhSekarang <= 0);
            }
        }

        // Fungsi yang dipanggil saat halaman pertama kali dimuat
        document.addEventListener('DOMContentLoaded', function() {
            logPesan("DOMContentLoaded: Menginisialisasi nilai awal.");

            // Inisialisasi dari variabel global yang diisi oleh meta tag AutoTools
            pemainMaxHP = parseInt(window.hpPemain) || 100;
            hpPemainSekarang = pemainMaxHP;

            musuhMaxHP = parseInt(window.hpMusuh) || 80;
            hpMusuhSekarang = musuhMaxHP;

            giliranSekarang = window.giliran || 'pemain';

            updateTampilanHP('Pemain', hpPemainSekarang, pemainMaxHP);
            updateTampilanHP('Musuh', hpMusuhSekarang, musuhMaxHP);
            updateStatus(window.pesanStatus || "Pertarungan dimulai!");
            updateTombolSerang();

            logPesan(`Pemain HP Awal: ${hpPemainSekarang}/${pemainMaxHP}, Musuh HP Awal: ${hpMusuhSekarang}/${musuhMaxHP}, Giliran: ${giliranSekarang}`);
        });

        // Fungsi yang akan dipanggil AutoTools untuk update
        var autoToolsUpdateValues = function(values) {
            logPesan("autoToolsUpdateValues dipanggil. Data: " + JSON.stringify(values));
            let butuhUpdateTombol = false;

            if (typeof values.hpPemain !== 'undefined') {
                hpPemainSekarang = parseInt(values.hpPemain);
                if (isNaN(hpPemainSekarang)) hpPemainSekarang = 0;
                // Jika HP pemain diupdate, Max HP mungkin juga perlu dipertimbangkan
                // Untuk contoh ini, kita asumsikan MaxHP tidak berubah via update ini kecuali ada variabel khusus
                updateTampilanHP('Pemain', hpPemainSekarang, pemainMaxHP);
                logPesan(`HP Pemain diupdate menjadi: ${hpPemainSekarang}`);
                butuhUpdateTombol = true;
            }
            if (typeof values.hpMusuh !== 'undefined') {
                hpMusuhSekarang = parseInt(values.hpMusuh);
                if (isNaN(hpMusuhSekarang)) hpMusuhSekarang = 0;
                updateTampilanHP('Musuh', hpMusuhSekarang, musuhMaxHP);
                logPesan(`HP Musuh diupdate menjadi: ${hpMusuhSekarang}`);
                butuhUpdateTombol = true;
            }
            if (typeof values.pesanStatus !== 'undefined') {
                updateStatus(values.pesanStatus);
            }
            if (typeof values.giliran !== 'undefined') {
                giliranSekarang = values.giliran;
                logPesan(`Giliran diupdate menjadi: ${giliranSekarang}`);
                butuhUpdateTombol = true; // Giliran berubah, tombol serang mungkin perlu di-enable/disable
            }

            if (butuhUpdateTombol) {
                updateTombolSerang();
                cekKondisiAkhir();
            }
        };

        // Aksi pemain
        function serangMusuh() {
            if (giliranSekarang !== 'pemain' || hpPemainSekarang <= 0 || hpMusuhSekarang <= 0) {
                logPesan("Serangan tidak valid (bukan giliran pemain / salah satu unit sudah KO).");
                return;
            }

            logPesan("Pemain menyerang musuh!");
            const damage = Math.floor(Math.random() * 10) + 15; // Damage acak 15-24
            hpMusuhSekarang = Math.max(0, hpMusuhSekarang - damage);
            updateTampilanHP('Musuh', hpMusuhSekarang, musuhMaxHP);
            updateStatus(`Pemain menyerang! Musuh menerima ${damage} damage.`);

            if (cekKondisiAkhir()) return;

            // Ganti giliran ke musuh (bisa di-handle Tasker atau otomatis)
            // Untuk demo ini, kita langsung ganti giliran dan musuh "menyerang" (dikontrol Tasker)
            giliranSekarang = 'musuh_bersiap'; // Status sementara sebelum Tasker mengambil alih
            updateTombolSerang();
            updateStatus("Musuh bersiap...");


            // Kirim command ke Tasker bahwa giliran pemain selesai & HP musuh berubah
            // Ini contoh, Anda perlu mengimplementasikan AutoTools.sendCommand jika file autotoolsfunctions.js disertakan
            // Jika tidak, Tasker bisa memantau perubahan melalui Update berkala atau trigger lain
            if (window.AutoTools && typeof window.AutoTools.sendCommand === 'function') {
                 window.AutoTools.sendCommand(`pemain_selesai:hpMusuh=${hpMusuhSekarang}`, "battleEvent", false);
                 logPesan("Mengirim command 'pemain_selesai' ke Tasker.");
            } else {
                logPesan("AutoTools.sendCommand tidak tersedia. Tasker perlu cara lain untuk deteksi giliran.");
            }
        }

        function cekKondisiAkhir() {
            if (hpMusuhSekarang <= 0) {
                updateStatus("Musuh dikalahkan! PEMAIN MENANG!");
                giliranSekarang = 'selesai';
                updateTombolSerang();
                return true;
            }
            if (hpPemainSekarang <= 0) {
                updateStatus("Pemain dikalahkan! MUSUH MENANG!");
                giliranSekarang = 'selesai';
                updateTombolSerang();
                return true;
            }
            return false;
        }

        window.tambahHpPemainGlobal = function(jumlahTambah) {
            if (typeof hpPemainSekarang !== 'undefined' && typeof pemainMaxHP !== 'undefined') {
                hpPemainSekarang = Math.min(pemainMaxHP, hpPemainSekarang + jumlahTambah);
                updateTampilanHP('Pemain', hpPemainSekarang, pemainMaxHP);
                updateStatus(`Pemain memulihkan ${jumlahTambah} HP!`);
                logPesan(`HP Pemain ditambah ${jumlahTambah} menjadi ${hpPemainSekarang} via fungsi global.`);
                cekKondisiAkhir(); // Cek apakah game berakhir (misalnya jika ini revive)
                updateTombolSerang(); // Update status tombol
                return true; // Berhasil
            }
            logPesan("Gagal menambah HP: variabel HP tidak terdefinisi.");
            return false; // Gagal
        };

        logPesan("Skrip inline_battle_test.html selesai dieksekusi. 'autoToolsUpdateValues' siap.");
    </script>
</body>
</html>
